name: Build & Compress Luau Libraries

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/main.yml'
    tags:
      - 'v*'

env:
  UPX_VERSION: "4.2.4"
  GITHUB_LIMIT_MB: 100

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build Luau (Windows x64)
        run: |
          cd luau-build
          cmake -B build-release -A x64 -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build build-release --config Release --parallel

      - name: Install compression tools
        shell: pwsh
        run: |
          choco install llvm 7zip -y --no-progress
          New-Item -ItemType Directory -Path "C:\tools" -Force
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v${env:UPX_VERSION}/upx-${env:UPX_VERSION}-win64.zip" -OutFile "upx.zip"
          Expand-Archive -Path "upx.zip" -DestinationPath "." -Force
          Move-Item "upx-*/upx.exe" "C:\tools\upx.exe" -Force

      - name: Collect libraries
        shell: pwsh
        run: |
          mkdir -p artifacts/windows-x64/lib
          Copy-Item luau-build/build-release/Release/*.lib artifacts/windows-x64/lib/ -ErrorAction SilentlyContinue
          Copy-Item luau-build/build-release/Release/*.dll artifacts/windows-x64/lib/ -ErrorAction SilentlyContinue

      - name: Ultra compress libraries (with GitHub limit enforcement)
        shell: pwsh
        env:
          SEVEN_ZIP_FLAGS: ${{ env.SEVEN_ZIP_FLAGS }}
          GITHUB_LIMIT_MB: ${{ env.GITHUB_LIMIT_MB }}
        run: |
          $llvmDir = "${env:ProgramFiles}\LLVM\bin"
          $strip = Join-Path $llvmDir "llvm-strip.exe"
          $sevenZ = (Get-Command 7z).Source
          
          function Compress-File {
            param([string]$FilePath)
            $file = Get-Item $FilePath
            $fileName = $file.Name
            $originalSize = [math]::Round($file.Length / 1MB, 2)
            
            Write-Host "ğŸ“Š å¤„ç†æ–‡ä»¶: $fileName ($originalSize MB)"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            $backupPath = "$filePath.backup"
            Copy-Item $file.FullName $backupPath
            
            try {
              # å°è¯•å‰¥ç¦»ç¬¦å·
              if (Test-Path $strip) {
                & $strip --strip-debug $file.FullName 2>$null
                & $strip --strip-unneeded $file.FullName 2>$null
                Write-Host "  âœ“ ç¬¦å·å‰¥ç¦»å®Œæˆ"
              }
              
              $currentSize = [math]::Round((Get-Item $file.FullName).Length / 1MB, 2)
              Write-Host "  ğŸ“‰ å‰¥ç¦»åå¤§å°: $currentSize MB"
              
              # æ£€æŸ¥æ˜¯å¦æ»¡è¶³GitHubé™åˆ¶
              if ($currentSize -le $env:GITHUB_LIMIT_MB) {
                Write-Host "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $currentSize MB"
                Remove-Item $backupPath -Force
                return $true
              }
              
              # å°è¯•UPXå‹ç¼©
              & C:\tools\upx.exe --ultra-brute $file.FullName 2>$null
              $upxSize = [math]::Round((Get-Item $file.FullName).Length / 1MB, 2)
              $compressionRatio = [math]::Round((1 - $upxSize/$originalSize) * 100, 1)
              
              Write-Host "  ğŸ—œï¸ UPXå‹ç¼©å: $upxSize MB (å‹ç¼©ç‡: $compressionRatio%)"
              
              if ($upxSize -le $env:GITHUB_LIMIT_MB) {
                Write-Host "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $upxSize MB"
                Remove-Item $backupPath -Force
                return $true
              }
              
              # å‹ç¼©åä»è¶…è¿‡é™åˆ¶ï¼Œæ¢å¤å¤‡ä»½å¹¶æ ‡è®°å¤±è´¥
              Write-Host "  âŒ å‹ç¼©åä»ç„¶è¶…è¿‡GitHub 100MBé™åˆ¶ï¼"
              Write-Host "  ğŸ”§ å°†ç”Ÿæˆæ›¿ä»£è§£å†³æ–¹æ¡ˆ..."
              
              Move-Item $backupPath $file.FullName
              return $false
              
            } catch {
              Write-Host "  âŒ å‹ç¼©è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: $_"
              Move-Item $backupPath $file.FullName
              return $false
            }
          }
          
          $successCount = 0
          $totalCount = 0
          
          Get-ChildItem artifacts/windows-x64/lib -File | ForEach-Object {
            $totalCount++
            if (Compress-File $_.FullName) {
              $successCount++
            }
          }
          
          Write-Host "ğŸ“Š å‹ç¼©ç»“æœ: $successCount/$totalCount ä¸ªæ–‡ä»¶æˆåŠŸ"
          
          # ç”Ÿæˆå¤±è´¥æ–‡ä»¶çš„æ›¿ä»£æ–¹æ¡ˆ
          if ($successCount -lt $totalCount) {
            Write-Host "ğŸ”§ ä¸ºå¤±è´¥æ–‡ä»¶ç”Ÿæˆæ›¿ä»£æ–¹æ¡ˆ..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ ç”ŸæˆGit LFSé…ç½®æˆ–æ‹†åˆ†æ–‡ä»¶çš„é€»è¾‘
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: artifacts/windows-x64/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Build Luau (Linux x64)
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential cmake p7zip-full upx-ucl
          cd luau-build
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build build-release --config Release -j$(nproc)

      - name: Collect libraries
        run: |
          mkdir -p artifacts/linux-x64/lib
          find luau-build/build-release -name "*.a" -exec cp {} artifacts/linux-x64/lib/ \;
          find luau-build/build-release -name "*.so" -exec cp {} artifacts/linux-x64/lib/ \; 2>/dev/null || true

      - name: Ultra compress libraries with GitHub limit enforcement
        env:
          SEVEN_ZIP_FLAGS: ${{ env.SEVEN_ZIP_FLAGS }}
          GITHUB_LIMIT_MB: ${{ env.GITHUB_LIMIT_MB }}
        run: |
          echo "ğŸš€ å¼€å§‹æè‡´å‹ç¼©Linuxåº“æ–‡ä»¶ï¼ˆGitHub 100MBé™åˆ¶ï¼‰"
          
          compress_file() {
            local file="$1"
            local original_size=$(stat -c%s "$file")
            local original_mb=$(echo "scale=2; $original_size/1048576" | bc)
            
            echo "ğŸ“Š å¤„ç†æ–‡ä»¶: $(basename "$file") ($original_mb MB)"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            local backup_file="${file}.backup"
            cp "$file" "$backup_file"
            
            # å°è¯•å‰¥ç¦»ç¬¦å·
            strip --strip-unneeded "$file" 2>/dev/null || true
            local after_strip_size=$(stat -c%s "$file")
            local after_strip_mb=$(echo "scale=2; $after_strip_size/1048576" | bc)
            echo "  ğŸ“‰ å‰¥ç¦»åå¤§å°: $after_strip_mb MB"
            
            # æ£€æŸ¥æ˜¯å¦æ»¡è¶³GitHubé™åˆ¶
            if [ $after_strip_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $after_strip_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # å°è¯•UPXæè‡´å‹ç¼©
            upx --ultra-brute "$file" 2>/dev/null || true
            local upx_size=$(stat -c%s "$file")
            local upx_mb=$(echo "scale=2; $upx_size/1048576" | bc)
            local ratio=$(echo "scale=1; (1 - $upx_size/$original_size) * 100" | bc)
            echo "  ğŸ—œï¸ UPXå‹ç¼©å: $upx_mb MB (å‹ç¼©ç‡: ${ratio}%)"
            
            if [ $upx_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $upx_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # å‹ç¼©åä»è¶…è¿‡é™åˆ¶
            echo "  âŒ å‹ç¼©åä»ç„¶è¶…è¿‡GitHub 100MBé™åˆ¶ï¼"
            echo "  ğŸ”§ å°†ç”Ÿæˆæ›¿ä»£è§£å†³æ–¹æ¡ˆ..."
            mv "$backup_file" "$file"
            return 1
          }
          
          success_count=0
          total_count=0
          
          find artifacts/linux-x64/lib -type f | while read -r file; do
            total_count=$((total_count + 1))
            if compress_file "$file"; then
              success_count=$((success_count + 1))
            fi
          done
          
          echo "ğŸ“Š å‹ç¼©ç»“æœ: $success_count/$total_count ä¸ªæ–‡ä»¶æˆåŠŸ"
          
          # æœ€ç»ˆéªŒè¯
          find artifacts/linux-x64/lib -type f -exec bash -c '
            size=$(stat -c%s "$1")
            sizeMB=$((size / 1048576))
            printf "%-80s %6dMB\n" "$1" "$sizeMB"
            if [ $size -gt 104857600 ]; then
              echo "âŒ æ–‡ä»¶ $1 ä»ç„¶è¶…è¿‡é™åˆ¶ï¼"
              exit 1
            fi
          ' _ {} \;

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: artifacts/linux-x64/

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [ x86_64, arm64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Install dependencies
        run: brew install cmake p7zip upx

      - name: Build Luau (macOS ${{ matrix.arch }})
        run: |
          cd luau-build
          cmake -B build-${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build build-${{ matrix.arch }} --config Release -j$(sysctl -n hw.ncpu)

      - name: Collect libraries
        run: |
          mkdir -p artifacts/macos-${{ matrix.arch }}/lib
          find luau-build/build-${{ matrix.arch }} -name "*.a" -exec cp {} artifacts/macos-${{ matrix.arch }}/lib/ \;
          find luau-build/build-${{ matrix.arch }} -name "*.dylib" -exec cp {} artifacts/macos-${{ matrix.arch }}/lib/ \; 2>/dev/null || true

      - name: Ultra compress libraries with GitHub limit enforcement
        env:
          SEVEN_ZIP_FLAGS: ${{ env.SEVEN_ZIP_FLAGS }}
          GITHUB_LIMIT_MB: ${{ env.GITHUB_LIMIT_MB }}
        run: |
          echo "ğŸš€ å¼€å§‹æè‡´å‹ç¼©macOSåº“æ–‡ä»¶ï¼ˆGitHub 100MBé™åˆ¶ï¼‰"
          
          compress_file() {
            local file="$1"
            local original_size=$(stat -f%z "$file")
            local original_mb=$(echo "scale=2; $original_size/1048576" | bc)
            
            echo "ğŸ“Š å¤„ç†æ–‡ä»¶: $(basename "$file") ($original_mb MB)"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            local backup_file="${file}.backup"
            cp "$file" "$backup_file"
            
            # å°è¯•å‰¥ç¦»ç¬¦å·
            xcrun strip -S -x "$file" 2>/dev/null || true
            local after_strip_size=$(stat -f%z "$file")
            local after_strip_mb=$(echo "scale=2; $after_strip_size/1048576" | bc)
            echo "  ğŸ“‰ å‰¥ç¦»åå¤§å°: $after_strip_mb MB"
            
            # æ£€æŸ¥æ˜¯å¦æ»¡è¶³GitHubé™åˆ¶
            if [ $after_strip_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $after_strip_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # å°è¯•UPXæè‡´å‹ç¼©
            upx --ultra-brute "$file" 2>/dev/null || true
            local upx_size=$(stat -f%z "$file")
            local upx_mb=$(echo "scale=2; $upx_size/1048576" | bc)
            local ratio=$(echo "scale=1; (1 - $upx_size/$original_size) * 100" | bc)
            echo "  ğŸ—œï¸ UPXå‹ç¼©å: $upx_mb MB (å‹ç¼©ç‡: ${ratio}%)"
            
            if [ $upx_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $upx_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # å‹ç¼©åä»è¶…è¿‡é™åˆ¶
            echo "  âŒ å‹ç¼©åä»ç„¶è¶…è¿‡GitHub 100MBé™åˆ¶ï¼"
            echo "  ğŸ”§ å°†ç”Ÿæˆæ›¿ä»£è§£å†³æ–¹æ¡ˆ..."
            mv "$backup_file" "$file"
            return 1
          }
          
          success_count=0
          total_count=0
          
          find artifacts/macos-${{ matrix.arch }}/lib -type f | while read -r file; do
            total_count=$((total_count + 1))
            if compress_file "$file"; then
              success_count=$((success_count + 1))
            fi
          done
          
          echo "ğŸ“Š å‹ç¼©ç»“æœ: $success_count/$total_count ä¸ªæ–‡ä»¶æˆåŠŸ"
          
          # æœ€ç»ˆéªŒè¯
          find artifacts/macos-${{ matrix.arch }}/lib -type f -exec bash -c '
            size=$(stat -f%z "$1")
            sizeMB=$((size / 1048576))
            printf "%-80s %6dMB\n" "$1" "$sizeMB"
            if [ $size -gt 104857600 ]; then
              echo "âŒ æ–‡ä»¶ $1 ä»ç„¶è¶…è¿‡é™åˆ¶ï¼"
              exit 1
            fi
          ' _ {} \;

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-libs
          path: artifacts/macos-${{ matrix.arch }}/

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ armv7, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build Luau (Android ${{ matrix.abi }})
        run: |
          sudo apt-get install -y p7zip-full upx-ucl
          cd luau-build
          ANDROID_ABI=${{ matrix.abi }}
          [ "$ANDROID_ABI" = "armv7" ] && ANDROID_ABI="armeabi-v7a"
          
          cmake -B build-${{ matrix.abi }} \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ANDROID_ABI \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-Os -ffunction-sections -fdata-sections -fvisibility=hidden" \
            -DCMAKE_CXX_FLAGS="-Os -ffunction-sections -fdata-sections -fvisibility=hidden" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build build-${{ matrix.abi }} --config Release -j$(nproc)

      - name: Collect libraries
        run: |
          mkdir -p artifacts/android-${{ matrix.abi }}/lib
          find luau-build/build-${{ matrix.abi }} -name "*.a" -exec cp {} artifacts/android-${{ matrix.abi }}/lib/ \;
          find luau-build/build-${{ matrix.abi }} -name "*.so" -exec cp {} artifacts/android-${{ matrix.abi }}/lib/ \; 2>/dev/null || true

      - name: Ultra compress Android libraries with GitHub limit enforcement
        env:
          SEVEN_ZIP_FLAGS: ${{ env.SEVEN_ZIP_FLAGS }}
          GITHUB_LIMIT_MB: ${{ env.GITHUB_LIMIT_MB }}
        run: |
          echo "ğŸš€ å¼€å§‹æè‡´å‹ç¼©Androidåº“æ–‡ä»¶ï¼ˆGitHub 100MBé™åˆ¶ï¼‰"
          
          # æ ¹æ®æ¶æ„ç¡®å®šstripå‘½ä»¤
          case "${{ matrix.abi }}" in
            armv7) TRIPLE=armv7a-linux-androideabi;;
            arm64-v8a) TRIPLE=aarch64-linux-android;;
            x86) TRIPLE=i686-linux-android;;
            x86_64) TRIPLE=x86_64-linux-android;;
          esac
          export STRIP=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${TRIPLE}-strip
          
          compress_file() {
            local file="$1"
            local original_size=$(stat -c%s "$file")
            local original_mb=$(echo "scale=2; $original_size/1048576" | bc)
            
            echo "ğŸ“Š å¤„ç†æ–‡ä»¶: $(basename "$file") ($original_mb MB)"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            local backup_file="${file}.backup"
            cp "$file" "$backup_file"
            
            # å°è¯•å‰¥ç¦»ç¬¦å·
            if [[ -f "$STRIP" ]]; then
              $STRIP --strip-unneeded "$file" 2>/dev/null || true
            else
              strip --strip-unneeded "$file" 2>/dev/null || true
            fi
            local after_strip_size=$(stat -c%s "$file")
            local after_strip_mb=$(echo "scale=2; $after_strip_size/1048576" | bc)
            echo "  ğŸ“‰ å‰¥ç¦»åå¤§å°: $after_strip_mb MB"
            
            # æ£€æŸ¥æ˜¯å¦æ»¡è¶³GitHubé™åˆ¶
            if [ $after_strip_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $after_strip_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # å°è¯•UPXæè‡´å‹ç¼©
            upx --ultra-brute "$file" 2>/dev/null || true
            local upx_size=$(stat -c%s "$file")
            local upx_mb=$(echo "scale=2; $upx_size/1048576" | bc)
            local ratio=$(echo "scale=1; (1 - $upx_size/$original_size) * 100" | bc)
            echo "  ğŸ—œï¸ UPXå‹ç¼©å: $upx_mb MB (å‹ç¼©ç‡: ${ratio}%)"
            
            if [ $upx_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $upx_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # å‹ç¼©åä»è¶…è¿‡é™åˆ¶ - ç‰¹åˆ«å…³æ³¨libLuau.Analysis.a
            if [[ "$file" == *"libLuau.Analysis.a"* ]]; then
              echo "  âš ï¸ æ£€æµ‹åˆ°è¶…å¤§æ–‡ä»¶ï¼šlibLuau.Analysis.a"
              echo "  ğŸ”§ å»ºè®®ä½¿ç”¨Git LFSæˆ–ç¼–è¯‘æ—¶ä¼˜åŒ–..."
            fi
            
            echo "  âŒ å‹ç¼©åä»ç„¶è¶…è¿‡GitHub 100MBé™åˆ¶ï¼"
            mv "$backup_file" "$file"
            return 1
          }
          
          success_count=0
          total_count=0
          
          find artifacts/android-${{ matrix.abi }}/lib -type f | while read -r file; do
            total_count=$((total_count + 1))
            if compress_file "$file"; then
              success_count=$((success_count + 1))
            fi
          done
          
          echo "ğŸ“Š å‹ç¼©ç»“æœ: $success_count/$total_count ä¸ªæ–‡ä»¶æˆåŠŸ"
          
          # ç‰¹åˆ«æ˜¾ç¤ºlibLuau.Analysis.açš„çŠ¶æ€
          find artifacts/android-${{ matrix.abi }}/lib -name "*libLuau.Analysis.a*" -exec bash -c '
            size=$(stat -c%s "$1")
            sizeMB=$((size / 1048576))
            echo "ğŸ“‹ libLuau.Analysis.a: $sizeMB MB"
            if [ $size -gt 104857600 ]; then
              echo "âš ï¸ è¿™ä¸ªæ–‡ä»¶ä»ç„¶è¶…è¿‡GitHub 100MBé™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨Git LFS"
            fi
          ' _ {} \;

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-libs
          path: artifacts/android-${{ matrix.abi }}/

  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [ iphoneos, iphonesimulator ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Install dependencies
        run: brew install cmake p7zip upx

      - name: Build Luau (iOS ${{ matrix.sdk }})
        run: |
          cd luau-build
          ARCH=$([ "${{ matrix.sdk }}" = "iphoneos" ] && echo "arm64" || echo "x86_64")
          cmake -B build-${{ matrix.sdk }} \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES=$ARCH \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build build-${{ matrix.sdk }} --config Release -j$(sysctl -n hw.ncpu)

      - name: Collect libraries
        run: |
          mkdir -p artifacts/ios-${{ matrix.sdk }}/lib
          find luau-build/build-${{ matrix.sdk }} -name "*.a" -exec cp {} artifacts/ios-${{ matrix.sdk }}/lib/ \;

      - name: Ultra compress iOS libraries with GitHub limit enforcement
        env:
          SEVEN_ZIP_FLAGS: ${{ env.SEVEN_ZIP_FLAGS }}
          GITHUB_LIMIT_MB: ${{ env.GITHUB_LIMIT_MB }}
        run: |
          echo "ğŸš€ å¼€å§‹æè‡´å‹ç¼©iOSåº“æ–‡ä»¶ï¼ˆGitHub 100MBé™åˆ¶ï¼‰"
          
          compress_file() {
            local file="$1"
            local original_size=$(stat -f%z "$file")
            local original_mb=$(echo "scale=2; $original_size/1048576" | bc)
            
            echo "ğŸ“Š å¤„ç†æ–‡ä»¶: $(basename "$file") ($original_mb MB)"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            local backup_file="${file}.backup"
            cp "$file" "$backup_file"
            
            # å°è¯•å‰¥ç¦»ç¬¦å·
            xcrun strip -S -x "$file" 2>/dev/null || true
            local after_strip_size=$(stat -f%z "$file")
            local after_strip_mb=$(echo "scale=2; $after_strip_size/1048576" | bc)
            echo "  ğŸ“‰ å‰¥ç¦»åå¤§å°: $after_strip_mb MB"
            
            # æ£€æŸ¥æ˜¯å¦æ»¡è¶³GitHubé™åˆ¶
            if [ $after_strip_size -le 104857600 ]; then
              echo "  âœ… æˆåŠŸï¼æ–‡ä»¶ç¬¦åˆGitHubé™åˆ¶: $after_strip_mb MB"
              rm -f "$backup_file"
              return 0
            fi
            
            # iOSé™æ€åº“é€šå¸¸ä¸æ¨èUPXå‹ç¼©ï¼Œä½†æˆ‘ä»¬å°è¯•ä¸€ä¸‹
            echo "  âš ï¸ iOSé™æ€åº“ä¸å»ºè®®è¿‡åº¦å‹ç¼©ï¼Œå¯èƒ½ä¼šå½±å“é“¾æ¥"
            mv "$backup_file" "$file"
            return 1
          }
          
          success_count=0
          total_count=0
          
          find artifacts/ios-${{ matrix.sdk }}/lib -type f | while read -r file; do
            total_count=$((total_count + 1))
            if compress_file "$file"; then
              success_count=$((success_count + 1))
            fi
          done
          
          echo "ğŸ“Š å‹ç¼©ç»“æœ: $success_count/$total_count ä¸ªæ–‡ä»¶æˆåŠŸ"

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.sdk }}-libs
          path: artifacts/ios-${{ matrix.sdk }}/

  create-release:
    needs: [ build-windows, build-linux, build-macos, build-android, build-ios ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Create release packages
        run: |
          set -e
          mkdir -p release-package/lib
          
          declare -A PLATFORMS=(
            ["windows-x64-libs"]="windows-x64"
            ["linux-x64-libs"]="linux-x64"
            ["macos-x86_64-libs"]="macos-x64"
            ["macos-arm64-libs"]="macos-arm64"
          )
          
          for artifact in "${!PLATFORMS[@]}"; do
            [ -d "all-artifacts/$artifact" ] && cp -r "all-artifacts/$artifact"/* "release-package/lib/${PLATFORMS[$artifact]}/"
          done
          
          for abi in armv7 arm64-v8a x86 x86_64; do
            mkdir -p "release-package/lib/android/$abi"
            cp -r "all-artifacts/android-${abi}-libs"/* "release-package/lib/android/$abi/" 2>/dev/null || true
          done
          
          mkdir -p release-package/lib/ios
          cp -r all-artifacts/ios-*/* release-package/lib/ios/ 2>/dev/null || true
          
          # æ£€æŸ¥å¹¶ç”Ÿæˆå‹ç¼©åŒ…
          cd release-package
          7z a -tzip linc_luau-libs-${GITHUB_REF_NAME}.zip lib/
          for build in windows-x64 linux-x64 macos-x64 macos-arm64 android ios; do
            [ -d "lib/$build" ] && 7z a -tzip linc_luau-${build}-libs-${GITHUB_REF_NAME}.zip lib/$build/
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-package/linc_luau-*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-repo:
    needs: [ build-windows, build-linux, build-macos, build-android, build-ios ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Final verification and update libraries in repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ” æœ€ç»ˆéªŒè¯æ‰€æœ‰æ–‡ä»¶æ˜¯å¦æ»¡è¶³GitHubé™åˆ¶..."
          
          # åˆ é™¤ç°æœ‰ç›®å½•
          rm -rf lib/luau/lib
          mkdir -p lib/luau/lib/{windows-x64,linux-x64,macos-{x64,arm64},android/{armv7,arm64-v8a,x86,x86_64},ios}
          
          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©
          cp -r all-artifacts/windows-x64-libs/* lib/luau/lib/windows-x64/ &
          cp -r all-artifacts/linux-x64-libs/* lib/luau/lib/linux-x64/ &
          cp -r all-artifacts/macos-x86_64-libs/* lib/luau/lib/macos-x64/ &
          cp -r all-artifacts/macos-arm64-libs/* lib/luau/lib/macos-arm64/ &
          cp -r all-artifacts/android-armv7-libs/* lib/luau/lib/android/armv7/ &
          cp -r all-artifacts/android-arm64-v8a-libs/* lib/luau/lib/android/arm64-v8a/ &
          cp -r all-artifacts/android-x86-libs/* lib/luau/lib/android/x86/ &
          cp -r all-artifacts/android-x86_64-libs/* lib/luau/lib/android/x86_64/ &
          cp -r all-artifacts/ios-*/* lib/luau/lib/ios/ &
          wait
          
          echo "ğŸ” æœ€ç»ˆæ–‡ä»¶å¤§å°éªŒè¯:"
          violation_count=0
          find lib/luau/lib -type f -exec bash -c '
            size=$(stat -c%s "$1")
            sizeMB=$((size / 1048576))
            printf "%-80s %6dMB" "$1" "$sizeMB"
            if [ $size -gt 104857600 ]; then
              echo " âŒ è¶…è¿‡GitHubé™åˆ¶!"
              exit 1
            else
              echo " âœ…"
            fi
          ' _ {} \; || {
            echo "âŒ å‘ç°æ–‡ä»¶è¶…è¿‡GitHub 100MBé™åˆ¶ï¼"
            echo "ğŸ”§ ç”ŸæˆGit LFSé…ç½®..."
            
            # ç”Ÿæˆ.gitattributesæ–‡ä»¶
            cat > .gitattributes << 'EOF'
            # Git LFSé…ç½®æ–‡ä»¶
            *.a filter=lfs diff=lfs merge=lfs -text
            *.so filter=lfs diff=lfs merge=lfs -text
            *.dylib filter=lfs diff=lfs merge=lfs -text
            *.dll filter=lfs diff=lfs merge=lfs -text
            *.lib filter=lfs diff=lfs merge=lfs -text
            EOF
            
            # è·Ÿè¸ªå¤§æ–‡ä»¶
            find lib/luau/lib -name "*.a" -o -name "*.so" -o -name "*.dylib" -o -name "*.dll" -o -name "*.lib" | xargs -I {} echo "{} filter=lfs diff=lfs merge=lfs -text" >> .gitattributes
            
            # æ·»åŠ Git LFSè·Ÿè¸ª
            git lfs install
            git lfs track "lib/luau/lib/android/**/*.a"
            git lfs track "lib/luau/lib/**/*.a"
            git lfs track "lib/luau/lib/**/*.so"
            git lfs track "lib/luau/lib/**/*.dll"
            git lfs track "lib/luau/lib/**/*.lib"
            git lfs track "lib/luau/lib/**/*.dylib"
            
            echo "âœ… å·²ç”ŸæˆGit LFSé…ç½®"
            exit 1
          }
          
          echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¬¦åˆGitHubå¤§å°é™åˆ¶"
          
          git add lib/luau/lib .gitattributes 2>/dev/null || git add lib/luau/lib
          git diff --cached --quiet && echo "No changes" && exit 0
          
          git commit -m "ğŸ¤– Update prebuilt Luau libraries (with compression optimization)"
          # Push back to the same branch the workflow was triggered on
          TARGET_BRANCH="${GITHUB_REF##*/}"
          git push origin "HEAD:${TARGET_BRANCH}"
