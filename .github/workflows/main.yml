name: Luau Libraries - ALL PLATFORMS Compile Compression

permissions:
  contents: write

on:
  push:
    branches: [ main, master ]
    paths:
      - 'lib/luau/lib/**'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

env:
  GITHUB_LIMIT_MB: 100

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: EXTREME Compile Compression (Windows)
        shell: bash
        run: |
          cd luau-build
          
          echo "ğŸš€ å¯ç”¨Windowsæè‡´ç¼–è¯‘å‹ç¼©..."
          
          cmake -B build-release -A x64 \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_C_FLAGS="/O1 /Ob2 /GL /Gw /GS- /fp:fast /Oy- /RTC1 /s /Zc:threadSafeInit- /arch:AVX2 /Oi /Ot /Oy /GF /Gy /Z7 /d1TrimMode=1 /d1TrimFileName=1 /MP /std:c++17" \
            -DCMAKE_CXX_FLAGS="/O1 /Ob2 /GL /Gw /GS- /fp:fast /Oy- /RTC1 /s /Zc:threadSafeInit- /arch:AVX2 /Oi /Ot /Oy /GF /Gy /Z7 /d1TrimMode=1 /d1TrimFileName=1 /MP /std:c++17 /Zc:inline- /permissive-" \
            -DCMAKE_EXE_LINKER_FLAGS="/LTCG /OPT:REF /OPT:ICF /DEBUG:NONE /SUBSYSTEM:WINDOWS /FIXED:NO /HIGHENTROPYVA /guard:cf /guard:ehcont /incremental:NO /opt:ref /opt:icf /opt:noref /debug:none /merge:.rdata=.text /merge:.data=.rdata /merge:.rsrc=.text /section:.text,erw /section:.data,erw" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          
          cmake --build build-release --config MinSizeRel --parallel
          
          echo "âœ… Windowsç¼–è¯‘å®Œæˆ"

      - name: Collect Windows Libraries
        run: |
          mkdir -p artifacts/windows-x64/lib
          Copy-Item luau-build/build-release/Release/*.lib artifacts/windows-x64/lib/ -ErrorAction SilentlyContinue
          Copy-Item luau-build/build-release/Release/*.dll artifacts/windows-x64/lib/ -ErrorAction SilentlyContinue

      - name: Windows Compile-Level Compression
        run: |
          echo "ğŸ”§ Windowsç¼–è¯‘çº§å‹ç¼©éªŒè¯"
          cd artifacts/windows-x64/lib
          
          Get-ChildItem *.lib, *.dll | ForEach-Object {
            $file = $_
            $size = $_.Length / 1MB
            Write-Host "æ–‡ä»¶: $($_.Name) - ${size}MB"
            
            if ($_.Length -gt 100MB) {
              Write-Host "âŒ è¶…è¿‡100MBé™åˆ¶"
              exit 1
            } else {
              Write-Host "âœ… ç¬¦åˆè¦æ±‚"
            }
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: artifacts/windows-x64/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Install Linux compile tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake llvm-dev binutils-multiarch

      - name: EXTREME Compile Compression (Linux x64)
        run: |
          cd luau-build
          
          echo "ğŸš€ å¯ç”¨Linuxæè‡´ç¼–è¯‘å‹ç¼©..."
          
          cmake -B build-release \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_C_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -finline-functions -finline-limit=5000 -march=x86-64 -mtune=generic -msse4.2 -maes" \
            -DCMAKE_CXX_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -finline-functions -finline-limit=5000 -march=x86-64 -mtune=generic -msse4.2 -maes" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections -Wl,--strip-all -Wl,--discard-all -Wl,--icf=all -Wl,--build-id=sha1 -Wl,--warn-shared-textrel -flto -Wl,--remove-section=.note -Wl,--remove-section=.comment -Wl,--strip-debug" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          
          cmake --build build-release --config MinSizeRel --parallel $(nproc)
          
          echo "âœ… Linuxç¼–è¯‘å®Œæˆ"

      - name: Collect Linux Libraries
        run: |
          mkdir -p artifacts/linux-x64/lib
          find luau-build/build-release -name "*.a" -exec cp {} artifacts/linux-x64/lib/ \;
          find luau-build/build-release -name "*.so" -exec cp {} artifacts/linux-x64/lib/ \; 2>/dev/null || true

      - name: Linux Compile-Level Compression
        run: |
          echo "ğŸ”§ Linuxç¼–è¯‘çº§å‹ç¼©éªŒè¯"
          
          find artifacts/linux-x64/lib -type f -exec bash -c '
            file="$1"
            size=$(stat -c%s "$file")
            sizeMB=$((size / 1048576))
            filename=$(basename "$file")
            
            printf "%-50s %6dMB" "$filename" "$sizeMB"
            
            if [ $size -gt 104857600 ]; then
              echo " âŒ è¶…è¿‡é™åˆ¶!"
              echo "é”™è¯¯: $filename ä»ç„¶ ${sizeMB}MB è¶…è¿‡100MB"
              exit 1
            else
              echo " âœ… ç¬¦åˆè¦æ±‚"
            fi
          ' _ {} \;

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: artifacts/linux-x64/

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [ x86_64, arm64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Install macOS compile tools
        run: |
          xcode-select --install || true

      - name: EXTREME Compile Compression (macOS ${{ matrix.arch }})
        run: |
          cd luau-build
          
          echo "ğŸš€ å¯ç”¨macOSæè‡´ç¼–è¯‘å‹ç¼© (${{ matrix.arch }})..."
          
          cmake -B build-${{ matrix.arch }} \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_C_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -finline-functions -finline-limit=5000" \
            -DCMAKE_CXX_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -finline-functions -finline-limit=5000" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,-dead_strip_dylibs -Wl,-dead_strip -Wl,-x -flto -Wl,-no_compact_unwind -Wl,-no_deduplicate -Wl,-search_paths_first" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          
          cmake --build build-${{ matrix.arch }} --config MinSizeRel --parallel $(sysctl -n hw.ncpu)
          
          echo "âœ… macOSç¼–è¯‘å®Œæˆ"

      - name: Collect macOS Libraries
        run: |
          mkdir -p artifacts/macos-${{ matrix.arch }}/lib
          find luau-build/build-${{ matrix.arch }} -name "*.a" -exec cp {} artifacts/macos-${{ matrix.arch }}/lib/ \;

      - name: macOS Compile-Level Compression
        run: |
          echo "ğŸ”§ macOSç¼–è¯‘çº§å‹ç¼©éªŒè¯ (${{ matrix.arch }})"
          
          find artifacts/macos-${{ matrix.arch }}/lib -type f -exec bash -c '
            file="$1"
            size=$(stat -f%z "$file")
            sizeMB=$((size / 1048576))
            filename=$(basename "$file")
            
            printf "%-50s %6dMB" "$filename" "$sizeMB"
            
            if [ $size -gt 104857600 ]; then
              echo " âŒ è¶…è¿‡é™åˆ¶!"
              echo "é”™è¯¯: $filename ä»ç„¶ ${sizeMB}MB è¶…è¿‡100MB"
              exit 1
            else
              echo " âœ… ç¬¦åˆè¦æ±‚"
            fi
          ' _ {} \;

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-libs
          path: artifacts/macos-${{ matrix.arch }}/

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ armv7, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Install Android compile tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake llvm-dev binutils-multiarch

      - name: EXTREME Compile Compression (Android ${{ matrix.abi }})
        run: |
          cd luau-build
          ANDROID_ABI=${{ matrix.abi }}
          [ "$ANDROID_ABI" = "armv7" ] && ANDROID_ABI="armeabi-v7a"
          
          echo "ğŸš€ å¯ç”¨Androidæè‡´ç¼–è¯‘å‹ç¼© (${{ matrix.abi }})..."
          
          cmake -B build-${{ matrix.abi }} \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ANDROID_ABI \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_C_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -fflat -finline-functions -finline-limit=5000" \
            -DCMAKE_CXX_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -fflat -finline-functions -finline-limit=5000" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections -Wl,--strip-all -Wl,--discard-all -Wl,--icf=all -Wl,--build-id=sha1 -Wl,--warn-shared-textrel -flto -Wl,--remove-section=.note -Wl,--remove-section=.comment -Wl,--strip-debug" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          
          cmake --build build-${{ matrix.abi }} --config MinSizeRel --parallel $(nproc)
          
          echo "âœ… Androidç¼–è¯‘å®Œæˆ"

      - name: Collect Android Libraries
        run: |
          mkdir -p artifacts/android-${{ matrix.abi }}/lib
          find luau-build/build-${{ matrix.abi }} -name "*.a" -exec cp {} artifacts/android-${{ matrix.abi }}/lib/ \;
          find luau-build/build-${{ matrix.abi }} -name "*.so" -exec cp {} artifacts/android-${{ matrix.abi }}/lib/ \; 2>/dev/null || true

      - name: Android Compile-Level Compression
        run: |
          echo "ğŸ”§ Androidç¼–è¯‘çº§å‹ç¼©éªŒè¯ (${{ matrix.abi }})"
          
          find artifacts/android-${{ matrix.abi }}/lib -type f -exec bash -c '
            file="$1"
            size=$(stat -c%s "$file")
            sizeMB=$((size / 1048576))
            filename=$(basename "$file")
            
            printf "%-50s %6dMB" "$filename" "$sizeMB"
            
            if [ $size -gt 104857600 ]; then
              echo " âŒ è¶…è¿‡é™åˆ¶!"
              echo "é”™è¯¯: $filename ä»ç„¶ ${sizeMB}MB è¶…è¿‡100MB"
              exit 1
            else
              echo " âœ… ç¬¦åˆè¦æ±‚"
            fi
          ' _ {} \;

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-libs
          path: artifacts/android-${{ matrix.abi }}/

  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [ iphoneos, iphonesimulator ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Install iOS compile tools
        run: |
          xcode-select --install || true

      - name: EXTREME Compile Compression (iOS ${{ matrix.sdk }})
        run: |
          cd luau-build
          ARCH=$([ "${{ matrix.sdk }}" = "iphoneos" ] && echo "arm64" || echo "x86_64")
          
          echo "ğŸš€ å¯ç”¨iOSæè‡´ç¼–è¯‘å‹ç¼© (${{ matrix.sdk }})..."
          
          cmake -B build-${{ matrix.sdk }} \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES=$ARCH \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_C_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -finline-functions -finline-limit=5000" \
            -DCMAKE_CXX_FLAGS="-Os -flto -fdata-sections -ffunction-sections -fvisibility=hidden -fmerge-constants -fmerge-constant-segments -fomit-frame-pointer -fno-exceptions -fno-rtti -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-stack-protector -fno-builtin -fno-instrument-functions -ftree-vectorize -ffast-math -fno-math-errno -falign-functions=64 -falign-jumps=64 -falign-loops=64 -fsection-anchors -fstrict-enums -finline-functions -finline-limit=5000" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,-dead_strip_dylibs -Wl,-dead_strip -Wl,-x -flto -Wl,-no_compact_unwind -Wl,-no_deduplicate -Wl,-search_paths_first" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          
          cmake --build build-${{ matrix.sdk }} --config MinSizeRel --parallel $(sysctl -n hw.ncpu)
          
          echo "âœ… iOSç¼–è¯‘å®Œæˆ"

      - name: Collect iOS Libraries
        run: |
          mkdir -p artifacts/ios-${{ matrix.sdk }}/lib
          find luau-build/build-${{ matrix.sdk }} -name "*.a" -exec cp {} artifacts/ios-${{ matrix.sdk }}/lib/ \;

      - name: iOS Compile-Level Compression
        run: |
          echo "ğŸ”§ iOSç¼–è¯‘çº§å‹ç¼©éªŒè¯ (${{ matrix.sdk }})"
          
          find artifacts/ios-${{ matrix.sdk }}/lib -type f -exec bash -c '
            file="$1"
            size=$(stat -f%z "$file")
            sizeMB=$((size / 1048576))
            filename=$(basename "$file")
            
            printf "%-50s %6dMB" "$filename" "$sizeMB"
            
            if [ $size -gt 104857600 ]; then
              echo " âŒ è¶…è¿‡é™åˆ¶!"
              echo "é”™è¯¯: $filename ä»ç„¶ ${sizeMB}MB è¶…è¿‡100MB"
              exit 1
            else
              echo " âœ… ç¬¦åˆè¦æ±‚"
            fi
          ' _ {} \;

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.sdk }}-libs
          path: artifacts/ios-${{ matrix.sdk }}/

  update-repo:
    needs: [ build-windows, build-linux, build-macos, build-android, build-ios ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Update Repository with Compressed Libraries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ” æ›´æ–°æ‰€æœ‰å¹³å°çš„åº“æ–‡ä»¶..."
          
          # åˆ é™¤ç°æœ‰ç›®å½•
          rm -rf lib/luau/lib
          mkdir -p lib/luau/lib/{windows-x64,linux-x64,macos-{x64,arm64},android/{armv7,arm64-v8a,x86,x86_64},ios}
          
          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©
          cp -r all-artifacts/windows-x64-libs/* lib/luau/lib/windows-x64/ &
          cp -r all-artifacts/linux-x64-libs/* lib/luau/lib/linux-x64/ &
          cp -r all-artifacts/macos-x86_64-libs/* lib/luau/lib/macos-x64/ &
          cp -r all-artifacts/macos-arm64-libs/* lib/luau/lib/macos-arm64/ &
          cp -r all-artifacts/android-armv7-libs/* lib/luau/lib/android/armv7/ &
          cp -r all-artifacts/android-arm64-v8a-libs/* lib/luau/lib/android/arm64-v8a/ &
          cp -r all-artifacts/android-x86-libs/* lib/luau/lib/android/x86/ &
          cp -r all-artifacts/android-x86_64-libs/* lib/luau/lib/android/x86_64/ &
          cp -r all-artifacts/ios-*/* lib/luau/lib/ios/ &
          wait
          
          echo ""
          echo "ğŸ” æ‰€æœ‰å¹³å°æ–‡ä»¶å¤§å°éªŒè¯:"
          echo "==============================="
          
          find lib/luau/lib -type f -exec bash -c '
            file="$1"
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            sizeMB=$((size / 1048576))
            printf "%-80s %6dMB" "$file" "$sizeMB"
            
            if [ $size -gt 104857600 ]; then
              echo " âŒ è¶…è¿‡é™åˆ¶!"
              exit 1
            else
              echo " âœ… ç¼–è¯‘çº§å‹ç¼©æˆåŠŸ"
            fi
          ' _ {} \; || {
            echo "âŒ æœ‰æ–‡ä»¶ä»ç„¶è¶…è¿‡100MBé™åˆ¶"
            echo "ğŸ’¡ å»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–ç¼–è¯‘é…ç½®"
            exit 1
          }
          
          echo ""
          echo "âœ… æ‰€æœ‰å¹³å°åº“æ–‡ä»¶ä»…é€šè¿‡ç¼–è¯‘çº§å‹ç¼©å°±ç¬¦åˆGitHub 100MBé™åˆ¶ï¼"
          
          git add lib/luau/lib
          git diff --cached --quiet && echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤" && exit 0
          
          git commit -m "ğŸ¤– Update prebuilt Luau libraries (ALL PLATFORMS compile compression)"
          
          # Push back to the same branch the workflow was triggered on
          TARGET_BRANCH="${GITHUB_REF##*/}"
          git push origin "HEAD:${TARGET_BRANCH}"

      - name: Final Platform Summary
        run: |
          echo "ğŸ“Š æ‰€æœ‰å¹³å°ç¼–è¯‘çº§å‹ç¼©æ€»ç»“"
          echo "=============================="
          
          echo "Windows x64:"
          find lib/luau/lib/windows-x64 -type f | while read file; do
            size=$(stat -c%s "$file")
            sizeMB=$(echo "scale=2; $size/1048576" | bc)
            echo "  $(basename "$file"): ${sizeMB}MB"
          done
          
          echo "Linux x64:"
          find lib/luau/lib/linux-x64 -type f | while read file; do
            size=$(stat -c%s "$file")
            sizeMB=$(echo "scale=2; $size/1048576" | bc)
            echo "  $(basename "$file"): ${sizeMB}MB"
          done
          
          echo "macOS (Intel/ARM):"
          find lib/luau/lib/macos-* -type f | while read file; do
            size=$(stat -f%z "$file")
            sizeMB=$(echo "scale=2; $size/1048576" | bc)
            echo "  $(basename "$file"): ${sizeMB}MB"
          done
          
          echo "Android (All ABIs):"
          find lib/luau/lib/android -type f | while read file; do
            size=$(stat -c%s "$file")
            sizeMB=$(echo "scale=2; $size/1048576" | bc)
            abi=$(echo "$file" | grep -o "android/[^/]*" | cut -d'/' -f2)
            echo "  $abi/$(basename "$file"): ${sizeMB}MB"
          done
          
          echo "iOS:"
          find lib/luau/lib/ios -type f | while read file; do
            size=$(stat -f%z "$file")
            sizeMB=$(echo "scale=2; $size/1048576" | bc)
            echo "  $(basename "$file"): ${sizeMB}MB"
          done
          
          echo ""
          echo "ğŸ‰ æ‰€æœ‰å¹³å°ç¼–è¯‘çº§å‹ç¼©å®Œæˆï¼"
