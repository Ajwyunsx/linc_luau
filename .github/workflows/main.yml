name: Build & Update Luau Libraries

permissions:
  contents: write

on:
  schedule:
    - cron: '*/30 * * * *' # 每 30 分钟运行一次
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/main.yml'
    tags:
      - 'v*'

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check-changes.outputs.should-build }}
      latest-commit: ${{ steps.check-changes.outputs.latest-commit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for updates in luau-lang/luau
        id: check-changes
        run: |
          LATEST_COMMIT=$(git ls-remote https://github.com/luau-lang/luau HEAD | awk '{print $1}')
          if [ -f .last_luau_commit ]; then
            LAST_COMMIT=$(cat .last_luau_commit)
          else
            LAST_COMMIT=""
          fi
          
          if [ "$LATEST_COMMIT" != "$LAST_COMMIT" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "latest-commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
            echo "New commit detected: $LATEST_COMMIT"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "latest-commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            echo "No new commits found"
          fi

  build-windows:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: windows-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/luau-lang/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch")
          PY

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build Luau (Windows x64)
        run: |
          cd luau-build
          mkdir build-release
          cd build-release
          cmake .. -DCMAKE_BUILD_TYPE=Release -A x64 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release

      - name: Setup LLVM and Compression Tools
        shell: pwsh
        run: |
          choco install llvm 7zip -y
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip" -OutFile "upx.zip"
          Expand-Archive -Path "upx.zip" -DestinationPath "."
          $upxFolder = Get-ChildItem -Directory -Filter "upx-*" | Select-Object -First 1
          Move-Item "$($upxFolder.FullName)/upx.exe" "upx.exe" -Force

      - name: Process and Compress Windows Libraries
        shell: pwsh
        run: |
          mkdir -p artifacts/windows-x64/lib
          Copy-Item luau-build/build-release/Release/*.lib artifacts/windows-x64/lib/
          Copy-Item luau-build/build-release/Release/*.dll artifacts/windows-x64/lib/ -ErrorAction SilentlyContinue

          $strip = "${env:ProgramFiles}\LLVM\bin\llvm-strip.exe"
          $upxPath = Join-Path $PWD "upx.exe"

          Get-ChildItem artifacts/windows-x64/lib -File | ForEach-Object {
            & $strip --strip-debug $_.FullName
          }

          Get-ChildItem artifacts/windows-x64/lib -Filter "*.dll" | ForEach-Object {
            & $upxPath --best --lzma --brute $_.FullName
          }

          Get-ChildItem artifacts/windows-x64/lib -File | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            if ($sizeMB -gt 90) {
              $targetFile = $_.FullName
              & 7z a -t7z -m0=lzma2 -mx=9 "$targetFile.7z" $targetFile
              Move-Item "$targetFile.7z" $targetFile -Force
            }
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: artifacts/windows-x64/

  build-linux:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/luau-lang/luau.git luau-build
          cd luau-build

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python3 - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
          PY

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake p7zip-full

      - name: Build Luau (Linux x64)
        run: |
          cd luau-build
          mkdir build-release
          cd build-release
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(nproc)

      - name: Collect and Ultra Compress Linux Libraries
        run: |
          mkdir -p artifacts/linux-x64/lib
          find luau-build/build-release -name "*.a" -exec cp {} artifacts/linux-x64/lib/ \;
          find luau-build/build-release -name "*.so" -exec cp {} artifacts/linux-x64/lib/ \; 2>/dev/null || true

          wget https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          
          compress_static_lib() {
            local lib="$1"
            local temp_dir=$(mktemp -d)
            local lib_abs_path=$(realpath "$lib")
            cd "$temp_dir"
            ar x "$lib_abs_path"
            for obj in *.o; do
              strip --strip-unneeded "$obj" 2>/dev/null || true
              ../../upx-4.2.2-amd64_linux/upx --best --lzma --brute "$obj" 2>/dev/null || true
            done
            rm -f "$lib_abs_path"
            ar rcs "$lib_abs_path" *.o
            ../../upx-4.2.2-amd64_linux/upx --best --lzma --brute "$lib_abs_path" 2>/dev/null || true
            cd -
          }

          for lib in artifacts/linux-x64/lib/*.a; do compress_static_lib "$lib"; done
          for lib in artifacts/linux-x64/lib/*.so; do
            strip --strip-unneeded "$lib"
            ./upx-4.2.2-amd64_linux/upx --best --lzma --brute "$lib" || true
          done

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: artifacts/linux-x64/

  build-macos:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [ x86_64, arm64 ]
    steps:
      - name: Clone Luau repository
        run: git clone https://github.com/luau-lang/luau.git luau-build

      - name: Build Luau (macOS ${{ matrix.arch }})
        run: |
          cd luau-build
          mkdir build-release-${{ matrix.arch }}
          cd build-release-${{ matrix.arch }}
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)

      - name: Collect and Compress macOS Libraries
        run: |
          brew install upx p7zip
          mkdir -p artifacts/macos-${{ matrix.arch }}/lib
          find luau-build/build-release-${{ matrix.arch }} -name "*.a" -exec cp {} artifacts/macos-${{ matrix.arch }}/lib/ \;
          
          for lib in artifacts/macos-${{ matrix.arch }}/lib/*.a; do
            strip -S -x "$lib"
            upx --best "$lib" 2>/dev/null || true
          done

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-libs
          path: artifacts/macos-${{ matrix.arch }}/

  build-android:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ armv7, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Clone Luau repository
        run: git clone https://github.com/luau-lang/luau.git luau-build

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build Luau (Android ${{ matrix.abi }})
        run: |
          cd luau-build
          mkdir build-android
          cd build-android
          ABI="${{ matrix.abi }}"
          if [ "$ABI" = "armv7" ]; then ABI="armeabi-v7a"; fi
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ABI \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF
          cmake --build . --config Release -j$(nproc)

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-libs
          path: luau-build/build-android/*.a

  build-ios:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [ iphoneos, iphonesimulator ]
    steps:
      - name: Clone Luau repository
        run: git clone https://github.com/luau-lang/luau.git luau-build

      - name: Build Luau (iOS ${{ matrix.sdk }})
        run: |
          cd luau-build
          mkdir build-ios
          cd build-ios
          ARCH="arm64"
          if [ "${{ matrix.sdk }}" = "iphonesimulator" ]; then ARCH="x86_64;arm64"; fi
          cmake .. \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="$ARCH" \
            -DCMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.sdk }}-libs
          path: luau-build/build-ios/*.a

  create-release:
    needs: [ check-updates, build-windows, build-linux, build-macos, build-android, build-ios ]
    if: always() && (needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare and Push Libraries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          mkdir -p lib/luau/lib
          # 示例：移动并整理目录逻辑... (根据你的需求 cp)
          # 快速合并所有下载的库到最终目录
          cp -r all-artifacts/**/* lib/luau/lib/ || true
          
          git add lib/luau/lib
          if ! git diff --cached --quiet; then
            git commit -m "Update prebuilt Luau libraries: ${{ needs.check-updates.outputs.latest-commit }}"
            git push origin main
          fi

      - name: Update last commit hash
        run: |
          echo "${{ needs.check-updates.outputs.latest-commit }}" > .last_luau_commit
          git add .last_luau_commit
          git commit -m "chore: update sync hash" || true
          git push origin main || true
