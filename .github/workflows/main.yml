name: Build & Update Luau Libraries

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/main.yml'
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path

          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch (already applied?)")
          PY

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Build Luau (Windows x64)
        run: |
          cd luau-build
          mkdir build-release
          cd build-release
          cmake .. -DCMAKE_BUILD_TYPE=Release -A x64 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release
          
      - name: Setup LLVM strip and compression tools
        shell: pwsh
        run: |
          choco install llvm 7zip -y
          refreshenv
          # Download UPX
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip" -OutFile "upx.zip"
          Expand-Archive -Path "upx.zip" -DestinationPath "."
          Move-Item "upx-*/upx.exe" "upx.exe" -Force

      - name: Collect and Compress Windows Libraries
        shell: pwsh
        run: |
          mkdir -p artifacts/windows-x64/lib
          
          # Debug: Show build directory contents
          Write-Host "Build directory contents:"
          if (Test-Path "luau-build/build-release/Release") {
            Get-ChildItem "luau-build/build-release/Release" | ForEach-Object { Write-Host "  $($_.Name)" }
          } else {
            Write-Host "  Release directory not found"
            if (Test-Path "luau-build/build-release") {
              Get-ChildItem "luau-build/build-release" | ForEach-Object { Write-Host "  $($_.Name)" }
            }
          }
          
          # Copy static libraries with verification
          Write-Host "Copying static libraries..."
          if (Test-Path "luau-build/build-release/Release/*.lib") {
            Get-ChildItem "luau-build/build-release/Release/*.lib" | ForEach-Object {
              Write-Host "  Found: $($_.Name)"
              Copy-Item $_.FullName "artifacts/windows-x64/lib/"
              Write-Host "  Copied to: artifacts/windows-x64/lib/$($_.Name)"
            }
          } else {
            Write-Host "  No .lib files found"
          }
          
          # Copy shared libraries with verification
          Write-Host "Copying shared libraries..."
          if (Test-Path "luau-build/build-release/Release/*.dll") {
            Get-ChildItem "luau-build/build-release/Release/*.dll" | ForEach-Object {
              Write-Host "  Found: $($_.Name)"
              Copy-Item $_.FullName "artifacts/windows-x64/lib/"
              Write-Host "  Copied to: artifacts/windows-x64/lib/$($_.Name)"
            }
          } else {
            Write-Host "  No .dll files found"
          }
          
          # Verify copied files
          Write-Host "Files in artifacts directory:"
          if (Test-Path "artifacts/windows-x64/lib") {
            Get-ChildItem "artifacts/windows-x64/lib" | ForEach-Object { Write-Host "  $($_.Name)" }
          } else {
            Write-Host "  Artifacts directory is empty"
          }
          
          $strip = "${env:ProgramFiles}\LLVM\bin\llvm-strip.exe"
          $upxPath = Join-Path $PWD "upx.exe"
          $arPath = "${env:ProgramFiles}\LLVM\bin\llvm-ar.exe"
          
          function Test-LibraryIntegrity {
            param([string]$LibraryPath)
            try {
              & $arPath t $LibraryPath | Out-Null
              return $true
            } catch {
              Write-Host "WARNING: Library integrity check failed for $LibraryPath"
              return $false
            }
          }
          
          function Compress-StaticLibrary {
            param([string]$LibraryPath, [string]$LibraryName)
            
            Write-Host "Processing static library: $LibraryName"
            Write-Host "Full path: $LibraryPath"
            
            # Check if file actually exists
            if (-not (Test-Path $LibraryPath)) {
              Write-Host "ERROR: File does not exist: $LibraryPath"
              return
            }
            
            if (-not (Test-LibraryIntegrity $LibraryPath)) {
              Write-Host "Skipping compression for $LibraryName due to integrity issues"
              return
            }
            
            $tempDir = Join-Path $env:TEMP "compress_$(Get-Random)"
            New-Item -ItemType Directory -Path $tempDir -Force
            
            try {
              Push-Location $tempDir
              Write-Host "Processing $LibraryName..."
              
              # Extract object files
              & $arPath x $LibraryPath
              $objectFiles = Get-ChildItem -Filter "*.obj"
              
              if ($objectFiles.Count -eq 0) {
                Write-Host "WARNING: No object files found in $LibraryName"
                Pop-Location
                return
              }
              
              # Compress each object file individually
              foreach ($obj in $objectFiles) {
                & $strip --strip-unneeded $obj.FullName 2>$null
                & $upxPath --best --lzma --brute $obj.FullName 2>$null
              }
              
              # Recreate library with compressed objects
              Remove-Item $LibraryPath -Force
              & $arPath rcs $LibraryPath *.obj
              
              # Final verification
              if (-not (Test-LibraryIntegrity $LibraryPath)) {
                Write-Error "Library integrity failed after compression for $LibraryName"
                exit 1
              }
              
              Pop-Location
              Write-Host "Successfully compressed $LibraryName"
            } finally {
              Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
            }
          }
          
          # Process static libraries safely
          Write-Host "Processing static libraries..."
          $staticLibs = Get-ChildItem "artifacts/windows-x64/lib" -Filter "*.lib" -ErrorAction SilentlyContinue
          if ($staticLibs) {
            $staticLibs | ForEach-Object { 
              Compress-StaticLibrary $_.FullName $_.Name
            }
          } else {
            Write-Host "No .lib files found to process"
          }
          
          # Process shared libraries safely
          Write-Host "Processing shared libraries..."
          $dllFiles = Get-ChildItem "artifacts/windows-x64/lib" -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($dllFiles) {
            $dllFiles | ForEach-Object { 
              & $strip --strip-debug --strip-unneeded $_.FullName 2>$null
              & $upxPath --best --lzma --brute $_.FullName 2>$null
            }
          } else {
            Write-Host "No .dll files found to process"
          }
          
          # Final size verification
          Write-Host "Library file sizes:"
          $allFiles = Get-ChildItem "artifacts/windows-x64/lib" -File -ErrorAction SilentlyContinue
          if ($allFiles) {
            $allFiles | ForEach-Object {
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "$($_.Name): $sizeMB MB"
            }
          } else {
            Write-Host "No files found in artifacts directory"
          }
          
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: artifacts/windows-x64/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path

          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch (already applied?)")
          PY

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake p7zip-full

      - name: Build Luau (Linux x64)
        run: |
          cd luau-build
          mkdir build-release
          cd build-release
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(nproc)
          
      - name: Download and Setup UPX
        run: |
          wget https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          chmod +x upx-4.2.2-amd64_linux/upx

      - name: Collect and Compress Linux Libraries
        run: |
          mkdir -p artifacts/linux-x64/lib
          
          # Debug: Show build directory contents
          echo "Build directory contents:"
          ls -la luau-build/build-release/ 2>/dev/null || echo "Build directory not found"
          
          # Copy static libraries with verification
          echo "Copying static libraries..."
          find luau-build/build-release -name "*.a" -exec sh -c '
            for file do
              echo "Found static library: $file"
              target="artifacts/linux-x64/lib/$(basename "$file")"
              cp "$file" "$target"
              echo "Copied to: $target"
            done
          ' sh {} +
          
          # Copy shared libraries with verification
          echo "Copying shared libraries..."
          find luau-build/build-release -name "*.so" -exec sh -c '
            for file do
              echo "Found shared library: $file"
              target="artifacts/linux-x64/lib/$(basename "$file")"
              cp "$file" "$target"
              echo "Copied to: $target"
            done
          ' sh {} +
          
          # Verify copied files
          echo "Files in artifacts directory:"
          ls -la artifacts/linux-x64/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
          # Function to verify library integrity
          verify_library() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
            return 0
          }
          
          # Function to compress static library with object-level compression
          compress_static_lib() {
            local lib="$1"
            local temp_dir=$(mktemp -d)
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              rm -rf "$temp_dir"
              return 1
            fi
            
            if ! verify_library "$lib"; then
              echo "Skipping compression for $lib_name due to integrity issues"
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd "$temp_dir"
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" | wc -l)
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Compress each object file
            for obj in *.o; do
              if [ -f "$obj" ]; then
                strip --strip-unneeded "$obj" 2>/dev/null || true
                ./upx-4.2.2-amd64_linux/upx --best --lzma --brute "$obj" 2>/dev/null || true
              fi
            done
            
            # Recreate the archive
            rm -f "$lib"
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to recreate $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd - > /dev/null
            rm -rf "$temp_dir"
            
            # Final verification
            if ! verify_library "$lib"; then
              echo "ERROR: Library integrity failed after compression for $lib_name"
              return 1
            fi
            
            echo "Successfully compressed $lib_name"
            return 0
          }
          
          # Process all static libraries safely
          echo "Processing static libraries..."
          if ls artifacts/linux-x64/lib/*.a 1> /dev/null 2>&1; then
            for lib in artifacts/linux-x64/lib/*.a; do
              if [ -f "$lib" ]; then
                compress_static_lib "$lib"
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
          fi
          
          # Process shared libraries safely
          echo "Processing shared libraries..."
          if ls artifacts/linux-x64/lib/*.so 1> /dev/null 2>&1; then
            for lib in artifacts/linux-x64/lib/*.so; do
              if [ -f "$lib" ]; then
                strip --strip-unneeded "$lib" 2>/dev/null || true
                ./upx-4.2.2-amd64_linux/upx --best --lzma --brute "$lib" 2>/dev/null || true
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .so files found to process"
          fi
          
          # Final size verification
          echo "Library file sizes:"
          if ls artifacts/linux-x64/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/linux-x64/lib/*; do
              if [ -f "$f" ]; then
                sizeMB=$(du -m "$f" | cut -f1)
                echo "$(basename "$f"): ${sizeMB} MB"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Test Library Functionality
        run: |
          echo "Running basic functionality tests..."
          
          # Test static libraries can be read
          for lib in artifacts/linux-x64/lib/*.a; do
            if [ -f "$lib" ]; then
              echo "Testing $(basename "$lib"):"
              ar t "$lib" | head -5
              if [ $? -eq 0 ]; then
                echo "✓ $(basename "$lib") is readable"
              else
                echo "✗ $(basename "$lib") failed readability test"
                exit 1
              fi
            fi
          done
          
          # Test shared libraries
          for lib in artifacts/linux-x64/lib/*.so; do
            if [ -f "$lib" ]; then
              echo "Testing $(basename "$lib"):"
              file "$lib"
              if file "$lib" | grep -q "shared object"; then
                echo "✓ $(basename "$lib") is a valid shared library"
              else
                echo "✗ $(basename "$lib") is not a valid shared library"
                exit 1
              fi
            fi
          done
          
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: artifacts/linux-x64/

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [ x86_64, arm64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path

          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch (already applied?)")
          PY

      - name: Install dependencies
        run: |
          brew install cmake p7zip upx

      - name: Build Luau (macOS ${{ matrix.arch }})
        run: |
          cd luau-build
          mkdir build-release-${{ matrix.arch }}
          cd build-release-${{ matrix.arch }}
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          
      - name: Collect and Compress macOS Libraries
        run: |
          mkdir -p artifacts/macos-${{ matrix.arch }}/lib
          
          # Debug: Show build directory contents
          echo "Build directory contents:"
          ls -la luau-build/build-release-${{ matrix.arch }}/ 2>/dev/null || echo "Build directory not found"
          
          # Copy static libraries with verification
          echo "Copying static libraries..."
          find luau-build/build-release-${{ matrix.arch }} -name "*.a" -exec sh -c '
            for file do
              echo "Found static library: $file"
              target="artifacts/macos-'"${{ matrix.arch }}"'/lib/$(basename "$file")"
              cp "$file" "$target"
              echo "Copied to: $target"
            done
          ' sh {} +
          
          # Copy shared libraries with verification
          echo "Copying shared libraries..."
          find luau-build/build-release-${{ matrix.arch }} -name "*.dylib" -exec sh -c '
            for file do
              echo "Found shared library: $file"
              target="artifacts/macos-'"${{ matrix.arch }}"'/lib/$(basename "$file")"
              cp "$file" "$target"
              echo "Copied to: $target"
            done
          ' sh {} +
          
          # Verify copied files
          echo "Files in artifacts directory:"
          ls -la artifacts/macos-${{ matrix.arch }}/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
          UPX_BINARY=$(which upx)
          if [ -z "$UPX_BINARY" ]; then
            echo "WARNING: UPX not found, using basic compression only"
            UPX_BINARY="echo"
          fi
          
          # Function to verify library integrity for macOS
          verify_library_macos() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
            return 0
          }
          
          # Function to compress static library for macOS
          compress_static_lib_macos() {
            local lib="$1"
            local temp_dir=$(mktemp -d)
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              rm -rf "$temp_dir"
              return 1
            fi
            
            if ! verify_library_macos "$lib"; then
              echo "Skipping compression for $lib_name due to integrity issues"
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd "$temp_dir"
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" | wc -l)
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Compress each object file
            for obj in *.o; do
              if [ -f "$obj" ]; then
                strip -S -x "$obj" 2>/dev/null || true
                "$UPX_BINARY" --best --lzma --brute "$obj" 2>/dev/null || true
              fi
            done
            
            # Recreate the archive
            rm -f "$lib"
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to recreate $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd - > /dev/null
            rm -rf "$temp_dir"
            
            # Final verification
            if ! verify_library_macos "$lib"; then
              echo "ERROR: Library integrity failed after compression for $lib_name"
              return 1
            fi
            
            echo "Successfully compressed $lib_name"
            return 0
          }
          
          # Process all static libraries safely
          echo "Processing static libraries..."
          if ls artifacts/macos-${{ matrix.arch }}/lib/*.a 1> /dev/null 2>&1; then
            for lib in artifacts/macos-${{ matrix.arch }}/lib/*.a; do
              if [ -f "$lib" ]; then
                compress_static_lib_macos "$lib"
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
          fi
          
          # Process shared libraries safely
          echo "Processing shared libraries..."
          if ls artifacts/macos-${{ matrix.arch }}/lib/*.dylib 1> /dev/null 2>&1; then
            for lib in artifacts/macos-${{ matrix.arch }}/lib/*.dylib; do
              if [ -f "$lib" ]; then
                strip -S -x "$lib" 2>/dev/null || true
                "$UPX_BINARY" --best --lzma --brute "$lib" 2>/dev/null || true
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .dylib files found to process"
          fi
          
          # Final size verification
          echo "Library file sizes:"
          if ls artifacts/macos-${{ matrix.arch }}/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/macos-${{ matrix.arch }}/lib/*; do
              if [ -f "$f" ]; then
                sizeMB=$(du -m "$f" | cut -f1)
                echo "$(basename "$f"): ${sizeMB} MB"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Test macOS Library Functionality
        run: |
          echo "Running macOS functionality tests..."
          
          # Test static libraries
          for lib in artifacts/macos-${{ matrix.arch }}/lib/*.a; do
            if [ -f "$lib" ]; then
              echo "Testing $(basename "$lib"):"
              ar t "$lib" | head -5
              if [ $? -eq 0 ]; then
                echo "✓ $(basename "$lib") is readable"
              else
                echo "✗ $(basename "$lib") failed readability test"
                exit 1
              fi
            fi
          done
          
          # Test shared libraries
          for lib in artifacts/macos-${{ matrix.arch }}/lib/*.dylib; do
            if [ -f "$lib" ]; then
              echo "Testing $(basename "$lib"):"
              file "$lib"
              if file "$lib" | grep -q "Mach-O"; then
                echo "✓ $(basename "$lib") is a valid Mach-O library"
              else
                echo "✗ $(basename "$lib") is not a valid Mach-O library"
                exit 1
              fi
            fi
          done
          
      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-libs
          path: artifacts/macos-${{ matrix.arch }}/

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ armv7, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path

          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch (already applied?)")
          PY

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: Build Luau (Android ${{ matrix.abi }})
        run: |
          cd luau-build
          mkdir build-android-${{ matrix.abi }}
          cd build-android-${{ matrix.abi }}
          ANDROID_ABI=${{ matrix.abi }}
          if [ "${{ matrix.abi }}" = "armv7" ]; then ANDROID_ABI="armeabi-v7a"; fi
          
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${ANDROID_ABI} \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-Os -ffunction-sections -fdata-sections -fvisibility=hidden" \
            -DCMAKE_CXX_FLAGS="-Os -ffunction-sections -fdata-sections -fvisibility=hidden" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections" \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,--gc-sections" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(nproc)
          
      - name: Collect and Compress Android Libraries
        run: |
          mkdir -p artifacts/android-${{ matrix.abi }}/lib
          
          # Debug: Show build directory contents
          echo "Build directory contents:"
          ls -la luau-build/build-android-${{ matrix.abi }}/ 2>/dev/null || echo "Build directory not found"
          
          # Copy static libraries with verification and detailed logging
          echo "Copying static libraries..."
          if find luau-build/build-android-${{ matrix.abi }} -name "*.a" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-android-${{ matrix.abi }} -name "*.a" -exec sh -c '
              for file do
                echo "Found static library: $file"
                target="artifacts/android-'"${{ matrix.abi }}"'/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' sh {} +
          else
            echo "No .a files found in build directory"
            echo "Build directory contents:"
            find luau-build/build-android-${{ matrix.abi }} -type f 2>/dev/null | head -10
          fi
          
          # Copy shared libraries with verification and detailed logging
          echo "Copying shared libraries..."
          if find luau-build/build-android-${{ matrix.abi }} -name "*.so" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-android-${{ matrix.abi }} -name "*.so" -exec sh -c '
              for file do
                echo "Found shared library: $file"
                target="artifacts/android-'"${{ matrix.abi }}"'/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' sh {} +
          else
            echo "No .so files found in build directory"
          fi
          
          # Verify copied files
          echo "Files in artifacts directory:"
          ls -la artifacts/android-${{ matrix.abi }}/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
          case "${{ matrix.abi }}" in
            armv7) TRIPLE=armv7a-linux-androideabi;;
            arm64-v8a) TRIPLE=aarch64-linux-android;;
            x86) TRIPLE=i686-linux-android;;
            x86_64) TRIPLE=x86_64-linux-android;;
          esac
          STRIP_CMD=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/${TRIPLE}-strip
          
          # Download UPX
          wget https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          chmod +x upx-4.2.2-amd64_linux/upx
          
          # Function to verify Android library integrity
          verify_android_library() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
            return 0
          }
          
          # Enhanced safe compression for Android - preserve library format
          compress_android_library() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            local temp_dir=$(mktemp -d)
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists with enhanced verification
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              echo "Current directory: $(pwd)"
              echo "Files in $(dirname "$lib"):"
              ls -la "$(dirname "$lib)" 2>/dev/null || echo "Directory does not exist"
              rm -rf "$temp_dir"
              return 1
            fi
            
            echo "File exists and size: $(du -h "$lib" | cut -f1)"
            
            if ! verify_android_library "$lib"; then
              echo "Skipping compression for $lib_name due to integrity issues"
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd "$temp_dir"
            
            # Extract object files safely with better error handling
            echo "Extracting objects from $lib_name..."
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              echo "Working directory: $(pwd)"
              echo "Attempted to extract: $lib"
              echo "File details:"
              ls -la "$lib" 2>/dev/null || echo "Cannot access file"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" 2>/dev/null | wc -l)
            echo "Found $object_count object files"
            
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              echo "Contents of archive:"
              ar t "$lib" 2>/dev/null || echo "Cannot list archive contents"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Strip and compress each object file
            echo "Compressing object files..."
            for obj in *.o; do
              if [ -f "$obj" ]; then
                echo "Processing object: $obj"
                ${STRIP_CMD} --strip-unneeded "$obj" 2>/dev/null || true
                ./upx-4.2.2-amd64_linux/upx --best "$obj" 2>/dev/null || true
              fi
            done
            
            # Recreate the library to preserve ar format
            echo "Recreating library with compressed objects..."
            rm -f "$lib"
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to recreate $lib_name"
              echo "Objects available for recreation:"
              ls -la *.o 2>/dev/null || echo "No object files found"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd - > /dev/null
            rm -rf "$temp_dir"
            
            # Final verification
            if ! verify_android_library "$lib"; then
              echo "ERROR: Library integrity failed after compression for $lib_name"
              return 1
            fi
            
            echo "Successfully compressed $lib_name"
            return 0
          }
          
          # Process all static libraries safely with enhanced verification
          echo "Processing static libraries..."
          echo "Checking for .a files in: artifacts/android-${{ matrix.abi }}/lib/"
          if ls artifacts/android-${{ matrix.abi }}/lib/*.a 1> /dev/null 2>&1; then
            echo "Found .a files, processing..."
            for lib in artifacts/android-${{ matrix.abi }}/lib/*.a; do
              echo "Checking file: $lib"
              if [ -f "$lib" ]; then
                echo "File exists, compressing..."
                compress_android_library "$lib"
              else
                echo "WARNING: Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
            echo "Available files in directory:"
            ls -la artifacts/android-${{ matrix.abi }}/lib/ 2>/dev/null || echo "Directory does not exist or is empty"
          fi
          
          # Process shared libraries safely
          echo "Processing shared libraries..."
          if ls artifacts/android-${{ matrix.abi }}/lib/*.so 1> /dev/null 2>&1; then
            for lib in artifacts/android-${{ matrix.abi }}/lib/*.so; do
              if [ -f "$lib" ]; then
                ${STRIP_CMD} --strip-unneeded "$lib" 2>/dev/null || true
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .so files found to process"
          fi
          
          # Final verification
          echo "Android library file sizes:"
          if ls artifacts/android-${{ matrix.abi }}/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/android-${{ matrix.abi }}/lib/*; do
              if [ -f "$f" ]; then
                sizeMB=$(du -m "$f" | cut -f1)
                echo "$(basename "$f"): ${sizeMB} MB"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-libs
          path: artifacts/android-${{ matrix.abi }}/

  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [ iphoneos, iphonesimulator ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path

          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch (already applied?)")
          PY

      - name: Install dependencies
        run: |
          brew install cmake p7zip upx

      - name: Build Luau (iOS ${{ matrix.sdk }})
        run: |
          cd luau-build
          mkdir build-ios-${{ matrix.sdk }}
          cd build-ios-${{ matrix.sdk }}
          
          if [ "${{ matrix.sdk }}" = "iphoneos" ]; then
            ARCH="arm64"
          else
            ARCH="x86_64"
          fi
          
          cmake .. \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES=$ARCH \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-Os -ffunction-sections -fdata-sections" \
            -DCMAKE_CXX_FLAGS="-Os -ffunction-sections -fdata-sections" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          
      - name: Collect and Compress iOS Libraries
        run: |
          mkdir -p artifacts/ios-${{ matrix.sdk }}/lib
          
          # Debug: Show build directory contents
          echo "Build directory contents:"
          ls -la luau-build/build-ios-${{ matrix.sdk }}/ 2>/dev/null || echo "Build directory not found"
          echo "Release subdirectory:"
          ls -la luau-build/build-ios-${{ matrix.sdk }}/Release/ 2>/dev/null || echo "Release directory not found"
          
          # Copy static libraries with verification
          echo "Copying static libraries..."
          if [ -d "luau-build/build-ios-${{ matrix.sdk }}/Release" ]; then
            find luau-build/build-ios-${{ matrix.sdk }}/Release -name "*.a" -exec sh -c '
              for file do
                echo "Found static library: $file"
                target="artifacts/ios-'"${{ matrix.sdk }}"'/lib/$(basename "$file")"
                cp "$file" "$target"
                echo "Copied to: $target"
              done
            ' sh {} +
          else
            echo "Release directory not found, trying to find .a files anywhere"
            find luau-build/build-ios-${{ matrix.sdk }} -name "*.a" -exec sh -c '
              for file do
                echo "Found static library: $file"
                target="artifacts/ios-'"${{ matrix.sdk }}"'/lib/$(basename "$file")"
                cp "$file" "$target"
                echo "Copied to: $target"
              done
            ' sh {} +
          fi
          
          # Verify copied files
          echo "Files in artifacts directory:"
          ls -la artifacts/ios-${{ matrix.sdk }}/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
          UPX_BINARY=$(which upx)
          if [ -z "$UPX_BINARY" ]; then
            echo "WARNING: UPX not found, using basic compression only"
            UPX_BINARY="echo"
          fi
          
          # Function to verify iOS library integrity
          verify_ios_library() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
            return 0
          }
          
          # Function to compress static library for iOS
          compress_static_lib_ios() {
            local lib="$1"
            local temp_dir=$(mktemp -d)
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              rm -rf "$temp_dir"
              return 1
            fi
            
            if ! verify_ios_library "$lib"; then
              echo "Skipping compression for $lib_name due to integrity issues"
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd "$temp_dir"
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" | wc -l)
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Compress each object file
            for obj in *.o; do
              if [ -f "$obj" ]; then
                xcrun strip -S -x "$obj" 2>/dev/null || true
                "$UPX_BINARY" --best --lzma --brute "$obj" 2>/dev/null || true
              fi
            done
            
            # Recreate the archive
            rm -f "$lib"
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to recreate $lib_name"
              cd - > /dev/null
              rm -rf "$temp_dir"
              return 1
            fi
            
            cd - > /dev/null
            rm -rf "$temp_dir"
            
            # Final verification
            if ! verify_ios_library "$lib"; then
              echo "ERROR: Library integrity failed after compression for $lib_name"
              return 1
            fi
            
            echo "Successfully compressed $lib_name"
            return 0
          }
          
          # Process all static libraries safely
          echo "Processing static libraries..."
          if ls artifacts/ios-${{ matrix.sdk }}/lib/*.a 1> /dev/null 2>&1; then
            for lib in artifacts/ios-${{ matrix.sdk }}/lib/*.a; do
              if [ -f "$lib" ]; then
                compress_static_lib_ios "$lib"
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
          fi
          
          # Final size verification
          echo "iOS library file sizes:"
          if ls artifacts/ios-${{ matrix.sdk }}/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/ios-${{ matrix.sdk }}/lib/*; do
              if [ -f "$f" ]; then
                sizeMB=$(du -m "$f" | cut -f1)
                echo "$(basename "$f"): ${sizeMB} MB"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.sdk }}-libs
          path: artifacts/ios-${{ matrix.sdk }}/

  create-release:
    needs: [ build-windows, build-linux, build-macos, build-android, build-ios ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Create release package
        run: |
          set -e
          mkdir -p release-package/lib
          for platform in windows-x64 linux-x64 macos-x64 macos-arm64; do
            mkdir -p release-package/lib/${platform}
          done
          
          cp -r all-artifacts/windows-x64-libs/* release-package/lib/windows-x64/ 2>/dev/null || true
          cp -r all-artifacts/linux-x64-libs/* release-package/lib/linux-x64/ 2>/dev/null || true
          cp -r all-artifacts/macos-x86_64-libs/* release-package/lib/macos-x64/ 2>/dev/null || true
          cp -r all-artifacts/macos-arm64-libs/* release-package/lib/macos-arm64/ 2>/dev/null || true
          
          mkdir -p release-package/lib/android/armv7
          mkdir -p release-package/lib/android/arm64-v8a
          mkdir -p release-package/lib/android/x86
          mkdir -p release-package/lib/android/x86_64
          cp -r all-artifacts/android-armv7-libs/* release-package/lib/android/armv7/ 2>/dev/null || true
          cp -r all-artifacts/android-arm64-v8a-libs/* release-package/lib/android/arm64-v8a/ 2>/dev/null || true
          cp -r all-artifacts/android-x86-libs/* release-package/lib/android/x86/ 2>/dev/null || true
          cp -r all-artifacts/android-x86_64-libs/* release-package/lib/android/x86_64/ 2>/dev/null || true
          
          mkdir -p release-package/lib/ios
          cp -r all-artifacts/ios-*/* release-package/lib/ios/ 2>/dev/null || true
          
          cd release-package/lib
          for build in windows-x64 linux-x64 macos-x64 macos-arm64 android ios; do
            if [ -d "${build}" ]; then
              zip -r ../linc_luau-${build}-libs-${GITHUB_REF_NAME}.zip ${build}
            fi
          done
          cd ../
          
          tar -czf ../linc_luau-libs-${GITHUB_REF_NAME}.tar.gz lib
          zip -r linc_luau-libs-${GITHUB_REF_NAME}.zip lib linc_luau-*libs-${GITHUB_REF_NAME}.zip

      - name: Create GitHub Release (only on tags v*)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linc_luau-libs-*.tar.gz
            linc_luau-libs-*.zip
            linc_luau-windows-x64-libs-*.zip
            linc_luau-linux-x64-libs-*.zip
            linc_luau-macos-x64-libs-*.zip
            linc_luau-macos-arm64-libs-*.zip
            linc_luau-android-libs-*.zip
            linc_luau-ios-libs-*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare repo and update libraries (NO LFS)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Fixed: Use proper bot name
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Ensure we are on main
          git fetch origin main
          git checkout main
          git pull origin main

          # Disable LFS completely
          git lfs uninstall || true
          rm -f .gitattributes

          # Remove old libraries
          rm -rf lib/luau/lib || true

          # Create directory structure
          mkdir -p lib/luau/lib/windows-x64
          mkdir -p lib/luau/lib/linux-x64
          mkdir -p lib/luau/lib/macos-x64
          mkdir -p lib/luau/lib/macos-arm64
          mkdir -p lib/luau/lib/android/armv7
          mkdir -p lib/luau/lib/android/arm64-v8a
          mkdir -p lib/luau/lib/android/x86
          mkdir -p lib/luau/lib/android/x86_64
          mkdir -p lib/luau/lib/ios

          # Copy new libraries from downloaded artifacts (already compressed)
          cp -r all-artifacts/windows-x64-libs/* lib/luau/lib/windows-x64/ 2>/dev/null || true
          cp -r all-artifacts/linux-x64-libs/* lib/luau/lib/linux-x64/ 2>/dev/null || true
          cp -r all-artifacts/macos-x86_64-libs/* lib/luau/lib/macos-x64/ 2>/dev/null || true
          cp -r all-artifacts/macos-arm64-libs/* lib/luau/lib/macos-arm64/ 2>/dev/null || true
          cp -r all-artifacts/android-armv7-libs/* lib/luau/lib/android/armv7/ 2>/dev/null || true
          cp -r all-artifacts/android-arm64-v8a-libs/* lib/luau/lib/android/arm64-v8a/ 2>/dev/null || true
          cp -r all-artifacts/android-x86-libs/* lib/luau/lib/android/x86/ 2>/dev/null || true
          cp -r all-artifacts/android-x86_64-libs/* lib/luau/lib/android/x86_64/ 2>/dev/null || true
          cp -r all-artifacts/ios-*/* lib/luau/lib/ios/ 2>/dev/null || true

          # Final verification - ensure all files are under 100MB and functional
          echo "Final file size and integrity verification:"
          
          # Test all static libraries
          for platform in windows-x64 linux-x64 macos-x64 macos-arm64 android ios; do
            if [ -d "lib/luau/lib/$platform" ]; then
              echo "=== Testing $platform libraries ==="
              for lib in lib/luau/lib/$platform/lib/*.{a,lib}; do
                if [ -f "$lib" ]; then
                  lib_name=$(basename "$lib")
                  size=$(du -h "$lib" | cut -f1)
                  echo "$lib_name: $size"
                  
                  # Test library integrity
                  if ar t "$lib" > /dev/null 2>&1; then
                    echo "✓ $lib_name integrity check passed"
                    symbol_count=$(ar t "$lib" | wc -l)
                    echo "  Contains $symbol_count object files"
                  else
                    echo "✗ $lib_name integrity check failed"
                    exit 1
                  fi
                  
                  # Size check
                  size_mb=$(du -m "$lib" | cut -f1)
                  if [ "$size_mb" -gt 95 ]; then
                    echo "ERROR: $lib_name is too large: ${size_mb}MB"
                    echo "Consider using smaller build flags or excluding large libraries"
                    exit 1
                  fi
                fi
              done
            fi
          done
          
          # Add everything to git (NO LFS)
          git add lib/luau/lib

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit with author as the user who triggered the workflow
          GIT_AUTHOR_NAME="${{ github.actor }}" \
          GIT_AUTHOR_EMAIL="${{ github.actor }}@users.noreply.github.com" \
          git commit -m "🤖 Update prebuilt Luau libraries for ${{ github.ref_name }}"

          # Push changes
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}"
          git push origin main
