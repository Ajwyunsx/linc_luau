# Updated workflow: apply size-optimizations and strip-and-repack .a (no in-place 7z).
# Focus: avoid replacing libraries with 7z; instead rebuild/strip/repack .a so the files remain valid static libs.

name: Build & Update Luau Libraries

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/main.yml'
    tags:
      - 'v*'

env:
  UPX_VERSION: "4.2.4"
  SEVEN_ZIP_FLAGS: "-t7z -mx=9 -myx=9 -ms=on -md=64m -mfb=256 -mmt=on"

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ armv7, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/Roblox/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          path.write_text(text.replace(marker, replacement, 1)) if marker in text else print("patch already applied")
          PY

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build Luau (Android ${{ matrix.abi }})
        run: |
          sudo apt-get install -y p7zip-full
          cd luau-build
          ANDROID_ABI=${{ matrix.abi }}
          [ "$ANDROID_ABI" = "armv7" ] && ANDROID_ABI="armeabi-v7a"

          # Add aggressive size optimizations and LTO where possible
          C_FLAGS="-Os -flto -ffunction-sections -fdata-sections -fvisibility=hidden"
          CXX_FLAGS="-Os -flto -ffunction-sections -fdata-sections -fvisibility=hidden -fno-exceptions -fno-rtti"
          LINK_FLAGS="-Wl,--gc-sections -flto"

          cmake -B build-${{ matrix.abi }} \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ANDROID_ABI \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="${C_FLAGS}" \
            -DCMAKE_CXX_FLAGS="${CXX_FLAGS}" \
            -DCMAKE_EXE_LINKER_FLAGS="${LINK_FLAGS}" \
            -DCMAKE_SHARED_LINKER_FLAGS="${LINK_FLAGS}" \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build build-${{ matrix.abi }} --config Release -j$(nproc)

      - name: Install UPX
        run: |
          wget -qO- https://github.com/upx/upx/releases/download/v${UPX_VERSION}/upx-${UPX_VERSION}-amd64_linux.tar.xz | tar -xJ
          sudo mv upx-${UPX_VERSION}-amd64_linux/upx /usr/local/bin/

      - name: Collect libraries
        run: |
          mkdir -p artifacts/android-${{ matrix.abi }}/lib
          find luau-build/build-${{ matrix.abi }} -name "*.a" -exec cp {} artifacts/android-${{ matrix.abi }}/lib/ \;
          find luau-build/build-${{ matrix.abi }} -name "*.so" -exec cp {} artifacts/android-${{ matrix.abi }}/lib/ \; 2>/dev/null || true

      - name: Ultra compress libraries (strip & repack .a, upx .so)
        env:
          SEVEN_ZIP_FLAGS: ${{ env.SEVEN_ZIP_FLAGS }}
        run: |
          case "${{ matrix.abi }}" in
            armv7) TRIPLE=armv7a-linux-androideabi;;
            arm64-v8a) TRIPLE=aarch64-linux-android;;
            x86) TRIPLE=i686-linux-android;;
            x86_64) TRIPLE=x86_64-linux-android;;
          esac
          export STRIP=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${TRIPLE}-strip
          JOBS=$(nproc)

          # 1) For static libraries (.a): unpack -> strip each .o -> repack (keeps .a format)
          find artifacts/android-${{ matrix.abi }}/lib -name "*.a" -print0 | xargs -0 -n1 -P $JOBS bash -c '
            A="$1"
            echo "Processing static archive: $A"
            TMP="$(mktemp -d)"
            cp "$A" "$TMP/lib.a"
            pushd "$TMP" >/dev/null
            ar x lib.a || { echo "ar x failed for $A"; exit 1; }
            for o in *.o; do
              [ -f "$o" ] || continue
              $STRIP --strip-unneeded "$o" 2>/dev/null || true
            done
            ar rcs lib.a *.o 2>/dev/null || true
            popd >/dev/null
            mv "$TMP/lib.a" "$A"
            rm -rf "$TMP"
            size=$(stat -c%s "$A" || echo 0)
            echo "$A -> $size bytes"
            [ "$size" -lt 100000000 ] || (echo "$A still >=100MB after strip" && exit 2)
          ' _ {}

          # 2) For shared libraries (.so): strip and try upx
          find artifacts/android-${{ matrix.abi }}/lib -name "*.so" -print0 | xargs -0 -n1 -P $JOBS bash -c '
            S="$1"
            echo "Processing shared lib: $S"
            $STRIP --strip-unneeded "$S" 2>/dev/null || true
            upx --ultra-brute "$S" 2>/dev/null || true
            size=$(stat -c%s "$S" || echo 0)
            echo "$S -> $size bytes"
            [ "$size" -lt 100000000 ] || (echo "$S still >=100MB after strip/upx" && exit 2)
          ' _ {}

          # Final listing & enforcement
          find artifacts/android-${{ matrix.abi }}/lib -type f -exec bash -c '
            size=$(stat -c%s "$1")
            sizeMB=$((size / 1048576))
            printf "%-80s %6dMB\n" "$1" "$sizeMB"
            [ $size -lt 100000000 ] || exit 1
          ' _ {} \;

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-libs
          path: artifacts/android-${{ matrix.abi }}/
