name: Build & Update Luau Libraries

permissions:
  contents: write

on:
  schedule:
    - cron: '*/30 * * * *' # 每 30 分钟运行一次
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/main.yml'
    tags:
      - 'v*'

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check-changes.outputs.should-build }}
      latest-commit: ${{ steps.check-changes.outputs.latest-commit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for updates in luau-lang/luau
        id: check-changes
        run: |
          LATEST_COMMIT=$(git ls-remote https://github.com/luau-lang/luau HEAD | awk '{print $1}')
          if [ -f .last_luau_commit ]; then
            LAST_COMMIT=$(cat .last_luau_commit)
          else
            LAST_COMMIT=""
          fi
          
          if [ "$LATEST_COMMIT" != "$LAST_COMMIT" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "latest-commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
            echo "New commit detected: $LATEST_COMMIT"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "latest-commit=$LAST_COMMIT" >> $GITHUB_OUTPUT
            echo "No new commits found"
          fi

  build-windows:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: windows-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/luau-lang/luau.git luau-build
          cd luau-build
          git log -1 --oneline

      - name: Patch Luau TypeChecker warning
        shell: bash
        run: |
          cd luau-build
          python - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
              print("patched TypeChecker2.cpp")
          else:
              print("marker not found; skipping patch")
          PY

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build Luau (Windows x64)
        run: |
          cd luau-build
          mkdir build-release
          cd build-release
          cmake .. -DCMAKE_BUILD_TYPE=Release -A x64 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release

      - name: Setup LLVM and Compression Tools
        shell: pwsh
        run: |
          choco install llvm 7zip -y
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip" -OutFile "upx.zip"
          Expand-Archive -Path "upx.zip" -DestinationPath "."
          $upxFolder = Get-ChildItem -Directory -Filter "upx-*" | Select-Object -First 1
          Move-Item "$($upxFolder.FullName)/upx.exe" "upx.exe" -Force

      - name: Process Windows Libraries
        shell: pwsh
        run: |
          mkdir -p artifacts/windows-x64/lib
          Copy-Item luau-build/build-release/Release/*.lib artifacts/windows-x64/lib/
          
          # 仅当存在 DLL 时才处理 DLL
          if (Test-Path "luau-build/build-release/Release/*.dll") {
            Copy-Item luau-build/build-release/Release/*.dll artifacts/windows-x64/lib/
            $upxPath = Join-Path $PWD "upx.exe"
            Get-ChildItem artifacts/windows-x64/lib -Filter "*.dll" | ForEach-Object {
              # DLL 可以安全地进行 strip 和 upx
              & $upxPath --best $_.FullName
            }
          }

          # 对于静态库 (.lib)，不要使用 strip 或 upx
          # 如果文件超过 90MB，使用 7z 压缩，用户下载后需自行解压
          Get-ChildItem artifacts/windows-x64/lib -Filter "*.lib" | ForEach-Object {
            if ($_.Length -gt 90MB) {
              Write-Host "正在压缩超大静态库: $($_.Name)"
              & 7z a -t7z -mx=9 "$($_.FullName).7z" $($_.FullName)
              Remove-Item $($_.FullName) # 移除原文件，只保留 .7z
            }
          }
          
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: artifacts/windows-x64/

  build-linux:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Clone Luau repository
        run: |
          git clone https://github.com/luau-lang/luau.git luau-build
          cd luau-build

      - name: Patch Luau TypeChecker warning
        run: |
          cd luau-build
          python3 - <<'PY'
          from pathlib import Path
          path = Path("Analysis/src/TypeChecker2.cpp")
          marker = "lookupAnnotation(ref->parameters.data 0 .type)"
          replacement = "lookupAnnotation(ann)"
          text = path.read_text()
          if marker in text:
              path.write_text(text.replace(marker, replacement, 1))
          PY

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake p7zip-full

      - name: Build Luau (Linux x64)
        run: |
          cd luau-build
          mkdir build-release
          cd build-release
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(nproc)

      - name: Collect and Ultra Compress Linux Libraries
        run: |
          mkdir -p artifacts/linux-x64/lib
          # 使用 find 确保即使没有找到文件也不会导致脚本崩溃
          find luau-build/build-release -name "*.a" -exec cp {} artifacts/linux-x64/lib/ \;
          find luau-build/build-release -name "*.so" -exec cp {} artifacts/linux-x64/lib/ \; 2>/dev/null || true
      
          # 修复 strip 报错：先检查文件是否存在
          if [ -d "artifacts/linux-x64/lib" ]; then
            # 处理静态库 .a
            find artifacts/linux-x64/lib/ -name "*.a" -exec strip --strip-debug {} \;
            
            # 处理动态库 .so (只有存在时才处理)
            shopt -s nullglob # 开启 nullglob，如果没有匹配到文件，变量为空而不是保留通配符
            for lib in artifacts/linux-x64/lib/*.so; do
              strip --strip-unneeded "$lib"
              ./upx-4.2.2-amd64_linux/upx --best --lzma --brute "$lib" || true
            done
          fi

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: artifacts/linux-x64/

  build-macos:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [ x86_64, arm64 ]
    steps:
      - name: Clone Luau repository
        run: git clone https://github.com/luau-lang/luau.git luau-build

      - name: Build Luau (macOS ${{ matrix.arch }})
        run: |
          cd luau-build
          mkdir build-release-${{ matrix.arch }}
          cd build-release-${{ matrix.arch }}
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)

      - name: Collect and Compress macOS Libraries
        run: |
          brew install upx p7zip
          mkdir -p artifacts/macos-${{ matrix.arch }}/lib
          find luau-build/build-release-${{ matrix.arch }} -name "*.a" -exec cp {} artifacts/macos-${{ matrix.arch }}/lib/ \;
          
          for lib in artifacts/macos-${{ matrix.arch }}/lib/*.a; do
            strip -S -x "$lib"
            upx --best "$lib" 2>/dev/null || true
          done

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-libs
          path: artifacts/macos-${{ matrix.arch }}/

  build-android:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ armv7, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Clone Luau repository
        run: git clone https://github.com/luau-lang/luau.git luau-build

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Build Luau (Android ${{ matrix.abi }})
        run: |
          cd luau-build
          mkdir build-android
          cd build-android
          ABI="${{ matrix.abi }}"
          if [ "$ABI" = "armv7" ]; then ABI="armeabi-v7a"; fi
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ABI \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF
          cmake --build . --config Release -j$(nproc)

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-libs
          path: luau-build/build-android/*.a

  build-ios:
    needs: check-updates
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [ iphoneos, iphonesimulator ]
    steps:
      - name: Clone Luau repository
        run: git clone https://github.com/luau-lang/luau.git luau-build
  
      - name: Build Luau (iOS ${{ matrix.sdk }})
        run: |
          cd luau-build
          mkdir build-ios
          cd build-ios

          if [ "${{ matrix.sdk }}" = "iphoneos" ]; then
            ARCH="arm64"
          else
            ARCH="x86_64;arm64"
          fi
  
          cmake .. \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} \
            -DCMAKE_OSX_ARCHITECTURES="$ARCH" \
            -DCMAKE_BUILD_TYPE=Release \
            -DLUAU_BUILD_TESTS=OFF \
            -DLUAU_BUILD_CLI=OFF \
            -DLUAU_BUILD_WEB=OFF \
            -DCMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY
  
          cmake --build . --config Release -j 2

  create-release:
    needs: [ check-updates, build-windows, build-linux, build-macos, build-android, build-ios ]
    if: always() && (needs.check-updates.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare and Push Libraries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          mkdir -p lib/luau/lib
          # 示例：移动并整理目录逻辑... (根据你的需求 cp)
          # 快速合并所有下载的库到最终目录
          cp -r all-artifacts/**/* lib/luau/lib/ || true
          
          git add lib/luau/lib
          if ! git diff --cached --quiet; then
            git commit -m "Update prebuilt Luau libraries: ${{ needs.check-updates.outputs.latest-commit }}"
            git push origin main
          fi

      - name: Update last commit hash
        run: |
          echo "${{ needs.check-updates.outputs.latest-commit }}" > .last_luau_commit
          git add .last_luau_commit
          git commit -m "chore: update sync hash" || true
          git push origin main || true
