name: Build & Update Luau Libraries

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [ published ]

env:
  LUAU_VERSION: "0.615"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Ninja
        uses: ajshort/actions/ninja@v1
        
      - name: Setup LLVM
        run: |
          Invoke-WebRequest -Uri "https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/LLVM-17.0.6-win64.exe" -OutFile "LLVM.exe"
          Start-Process -Wait -FilePath "LLVM.exe" -ArgumentList "/S"
          
      - name: Build Windows libraries
        run: |
          mkdir build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DLUAU_BUILD_TOOLS=ON
          cmake --build . --config Release
          
      - name: Create artifacts directory
        run: |
          mkdir -p artifacts/windows-x64/lib
          
      - name: Copy static libraries with verification
        run: |
          Write-Host "Copying static libraries..."
          if (Test-Path "luau-build/build-release/Release/*.lib") {
            Get-ChildItem "luau-build/build-release/Release/*.lib" | ForEach-Object {
              Write-Host "  Found: $($_.Name)"
              Copy-Item $_.FullName "artifacts/windows-x64/lib/"
              Write-Host "  Copied to: artifacts/windows-x64/lib/$($_.Name)"
            }
          } else {
            Write-Host "  No .lib files found"
          }
          
      - name: Copy shared libraries with verification
        run: |
          Write-Host "Copying shared libraries..."
          if (Test-Path "luau-build/build-release/Release/*.dll") {
            Get-ChildItem "luau-build/build-release/Release/*.dll" | ForEach-Object {
              Write-Host "  Found: $($_.Name)"
              Copy-Item $_.FullName "artifacts/windows-x64/lib/"
              Write-Host "  Copied to: artifacts/windows-x64/lib/$($_.Name)"
            }
          } else {
            Write-Host "  No .dll files found"
          }
          
      - name: Verify copied files
        run: |
          Write-Host "Files in artifacts directory:"
          if (Test-Path "artifacts/windows-x64/lib") {
            Get-ChildItem "artifacts/windows-x64/lib" | ForEach-Object { Write-Host "  $($_.Name)" }
          } else {
            Write-Host "  Artifacts directory is empty"
          }
          
      - name: Setup compression tools
        run: |
          $strip = "${env:ProgramFiles}\LLVM\bin\llvm-strip.exe"
          $upxPath = Join-Path $PWD "upx.exe"
          $arPath = "${env:ProgramFiles}\LLVM\bin\llvm-ar.exe"
          
      - name: Compress libraries
        run: |
          $strip = "${env:ProgramFiles}\LLVM\bin\llvm-strip.exe"
          $upxPath = Join-Path $PWD "upx.exe"
          $arPath = "${env:ProgramFiles}\LLVM\bin\llvm-ar.exe"
          
          function Test-LibraryIntegrity {
            param([string]$LibraryPath)
            try {
              & $arPath t $LibraryPath | Out-Null
              return $true
            } catch {
              Write-Host "WARNING: Library integrity check failed for $LibraryPath"
              return $false
            }
          }
          
          function Compress-StaticLibrary {
            param([string]$LibraryPath, [string]$LibraryName)
            
            Write-Host "Processing static library: $LibraryName"
            Write-Host "Full path: $LibraryPath"
            
            if (-not (Test-Path $LibraryPath)) {
              Write-Host "ERROR: Library file does not exist: $LibraryPath"
              return
            }
            
            if (-not (Test-LibraryIntegrity $LibraryPath)) {
              Write-Host "WARNING: Skipping invalid library: $LibraryName"
              return
            }
            
            $tempDir = Join-Path $PWD "temp_$LibraryName"
            Remove-Item -Recurse -Force $tempDir -ErrorAction SilentlyContinue
            New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
            
            try {
              Push-Location $tempDir
              & $arPath x "$LibraryPath"
              $objectFiles = Get-ChildItem "*.o" -ErrorAction SilentlyContinue
              
              if ($objectFiles.Count -eq 0) {
                Write-Host "WARNING: No object files found in $LibraryName"
                return
              }
              
              foreach ($obj in $objectFiles) {
                if (Test-Path $obj.FullName) {
                  & $strip --strip-all --remove-section=.comment --remove-section=.note $obj.FullName
                  if (Test-Path "upx.exe") {
                    & "./upx.exe" --best --lzma $obj.FullName
                  }
                }
              }
              
              & $ar rcs "$LibraryPath" *.o
              
              if (Test-LibraryIntegrity $LibraryPath) {
                $size = [math]::Round((Get-Item $LibraryPath).Length / 1MB, 2)
                Write-Host "Successfully compressed $LibraryName. New size: ${size}MB"
              } else {
                Write-Host "WARNING: Compression may have failed for $LibraryName"
              }
            } finally {
              Pop-Location
              Remove-Item -Recurse -Force $tempDir -ErrorAction SilentlyContinue
            }
          }
          
          function Compress-SharedLibrary {
            param([string]$LibraryPath, [string]$LibraryName)
            
            Write-Host "Processing shared library: $LibraryName"
            Write-Host "Full path: $LibraryPath"
            
            if (-not (Test-Path $LibraryPath)) {
              Write-Host "ERROR: Shared library file does not exist: $LibraryPath"
              return
            }
            
            try {
              & $strip --strip-all --remove-section=.comment --remove-section=.note $LibraryPath
              if (Test-Path "upx.exe") {
                & "./upx.exe" --best --lzma $LibraryPath
              }
              
              $size = [math]::Round((Get-Item $LibraryPath).Length / 1MB, 2)
              Write-Host "Successfully compressed $LibraryName. New size: ${size}MB"
            } catch {
              Write-Host "ERROR: Failed to compress $LibraryName"
            }
          }
          
          # Process static libraries
          if (Test-Path "artifacts/windows-x64/lib/*.lib") {
            Get-ChildItem "artifacts/windows-x64/lib/*.lib" | ForEach-Object {
              if (Test-Path $_.FullName) {
                Compress-StaticLibrary $_.FullName $_.Name
              } else {
                Write-Host "WARNING: Skipping non-existent file: $($_.Name)"
              }
            }
          } else {
            Write-Host "No .lib files found to process"
          }
          
          # Process shared libraries
          if (Test-Path "artifacts/windows-x64/lib/*.dll") {
            Get-ChildItem "artifacts/windows-x64/lib/*.dll" | ForEach-Object {
              if (Test-Path $_.FullName) {
                Compress-SharedLibrary $_.FullName $_.Name
              } else {
                Write-Host "WARNING: Skipping non-existent file: $($_.Name)"
              }
            }
          } else {
            Write-Host "No .dll files found to process"
          }
          
      - name: Final verification
        run: |
          Write-Host "Library file sizes:"
          if (Test-Path "artifacts/windows-x64/lib") {
            Get-ChildItem "artifacts/windows-x64/lib" | ForEach-Object {
              if (Test-Path $_.FullName) {
                $size = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  $($_.Name): ${size}MB"
              }
            }
          } else {
            Write-Host "No files found in artifacts directory"
          }
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luau-windows-x64
          path: artifacts/
          retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libstdc++-12-dev upx-ucl llvm-17-dev pkg-config
          
      - name: Setup UPX
        run: |
          wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          chmod +x upx-4.2.2-amd64_linux/upx
          sudo cp upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          
      - name: Build Linux libraries
        run: |
          mkdir -p luau-build/build-release
          cd luau-build/build-release
          cmake ../.. -G Ninja -DCMAKE_BUILD_TYPE=Release -DLUAU_BUILD_TOOLS=ON
          cmake --build . --config Release -j$(nproc)
          
      - name: Create artifacts directory
        run: |
          mkdir -p artifacts/linux-x64/lib
          
      - name: Copy static libraries with verification and detailed logging
        run: |
          echo "Copying static libraries..."
          if find luau-build/build-release -name "*.a" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-release -name "*.a" -exec bash -c '
              for file do
                echo "Found static library: $file"
                target="artifacts/linux-x64/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' bash {} +
          else
            echo "No .a files found in build directory"
            echo "Build directory contents:"
            find luau-build/build-release -type f 2>/dev/null | head -10
          fi
          
      - name: Copy shared libraries with verification and detailed logging
        run: |
          echo "Copying shared libraries..."
          if find luau-build/build-release -name "*.so" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-release -name "*.so" -exec bash -c '
              for file do
                echo "Found shared library: $file"
                target="artifacts/linux-x64/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' bash {} +
          else
            echo "No .so files found in build directory"
          fi
          
      - name: Verify copied files
        run: |
          echo "Files in artifacts directory:"
          ls -la artifacts/linux-x64/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
      - name: Setup compression tools
        run: |
          STRIP_BIN=$(which llvm-strip 2>/dev/null || which strip)
          AR_BIN=$(which llvm-ar 2>/dev/null || which ar)
          UPX_BIN=$(which upx)
          
      - name: Compress libraries
        run: |
          # Function to verify library integrity
          verify_library() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
          }
          
          # Function to compress static library
          compress_static_lib() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists with enhanced verification
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            # Check library integrity before processing
            if ! verify_library "$lib"; then
              echo "ERROR: Library integrity check failed for $lib_name"
              return 1
            fi
            
            # Extract object files safely with better error handling
            temp_dir=$(mktemp -d)
            cd "$temp_dir"
            
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              ls -la "$lib" 2>/dev/null || echo "Cannot access file"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" 2>/dev/null | wc -l)
            echo "Found $object_count object files"
            
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Compress each object file with detailed logging
            echo "Compressing object files..."
            for obj in *.o; do
              if [ -f "$obj" ]; then
                if [ -n "$STRIP_BIN" ]; then
                  "$STRIP_BIN" --strip-all --remove-section=.comment --remove-section=.note "$obj"
                fi
                if [ -n "$UPX_BIN" ]; then
                  "$UPX_BIN" --best --lzma "$obj"
                fi
              fi
            done
            
            # Repackage the library
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to repackage $lib_name"
              ls -la *.o 2>/dev/null || echo "No object files found"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Final verification
            if ! verify_library "$lib"; then
              echo "WARNING: Post-compression verification failed for $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
            rm -rf "$temp_dir"
          }
          
          # Function to compress shared library
          compress_shared_lib() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing shared library: $lib_name"
            
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            if [ -n "$STRIP_BIN" ]; then
              "$STRIP_BIN" --strip-all --remove-section=.comment --remove-section=.note "$lib"
            fi
            
            if [ -n "$UPX_BIN" ]; then
              "$UPX_BIN" --best --lzma "$lib"
            fi
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
          }
          
          # Process all static libraries safely with enhanced verification
          echo "Checking for .a files in: artifacts/linux-x64/lib/"
          if ls artifacts/linux-x64/lib/*.a 1> /dev/null 2>&1; then
            echo "Found .a files, processing..."
            for lib in artifacts/linux-x64/lib/*.a; do
              echo "Checking file: $lib"
              if [ -f "$lib" ]; then
                compress_static_lib "$lib"
              else
                echo "WARNING: Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
            echo "Available files in directory:"
            ls -la artifacts/linux-x64/lib/ 2>/dev/null || echo "Directory not accessible"
          fi
          
          # Process all shared libraries safely
          if ls artifacts/linux-x64/lib/*.so 1> /dev/null 2>&1; then
            for lib in artifacts/linux-x64/lib/*.so; do
              if [ -f "$lib" ]; then
                compress_shared_lib "$lib"
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .so files found to process"
          fi
          
      - name: Final size verification
        run: |
          echo "Library file sizes:"
          if ls artifacts/linux-x64/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/linux-x64/lib/*; do
              if [ -f "$f" ]; then
                echo "$(basename "$f"): $(du -h "$f" | cut -f1)"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luau-linux-x64
          path: artifacts/
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install dependencies
        run: |
          brew install cmake ninja llvm upx
          
      - name: Setup UPX
        run: |
          cp "$(brew --prefix)/bin/upx" ./upx
          chmod +x ./upx
          
      - name: Build macOS libraries
        run: |
          mkdir -p luau-build/build-release-${{ matrix.arch }}
          cd luau-build/build-release-${{ matrix.arch }}
          cmake ../.. -G Ninja -DCMAKE_BUILD_TYPE=Release -DLUAU_BUILD_TOOLS=ON -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          
      - name: Create artifacts directory
        run: |
          mkdir -p artifacts/macos-${{ matrix.arch }}/lib
          
      - name: Copy static libraries with verification and detailed logging
        run: |
          echo "Copying static libraries..."
          if find luau-build/build-release-${{ matrix.arch }} -name "*.a" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-release-${{ matrix.arch }} -name "*.a" -exec bash -c '
              for file do
                echo "Found static library: $file"
                target="artifacts/macos-'"${{ matrix.arch }}"'/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' bash {} +
          else
            echo "No .a files found in build directory"
            echo "Build directory contents:"
            find luau-build/build-release-${{ matrix.arch }} -type f 2>/dev/null | head -10
          fi
          
      - name: Copy shared libraries with verification and detailed logging
        run: |
          echo "Copying shared libraries..."
          if find luau-build/build-release-${{ matrix.arch }} -name "*.dylib" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-release-${{ matrix.arch }} -name "*.dylib" -exec bash -c '
              for file do
                echo "Found shared library: $file"
                target="artifacts/macos-'"${{ matrix.arch }}"'/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' bash {} +
          else
            echo "No .dylib files found in build directory"
          fi
          
      - name: Verify copied files
        run: |
          echo "Files in artifacts directory:"
          ls -la artifacts/macos-${{ matrix.arch }}/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
      - name: Setup compression tools
        run: |
          if [ -z "$UPX_BINARY" ]; then
            UPX_BINARY="./upx"
          fi
          
      - name: Compress libraries
        run: |
          # Function to verify library integrity for macOS
          verify_library_macos() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
          }
          
          # Function to compress static library for macOS
          compress_static_lib_macos() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists with enhanced verification
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            # Check library integrity before processing
            if ! verify_library_macos "$lib"; then
              echo "ERROR: Library integrity check failed for $lib_name"
              return 1
            fi
            
            # Extract object files safely with better error handling
            temp_dir=$(mktemp -d)
            cd "$temp_dir"
            
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              ls -la "$lib" 2>/dev/null || echo "Cannot access file"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" 2>/dev/null | wc -l)
            echo "Found $object_count object files"
            
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Compress each object file with detailed logging
            echo "Compressing object files..."
            for obj in *.o; do
              if [ -f "$obj" ]; then
                strip -x "$obj" 2>/dev/null || true
                if [ -n "$UPX_BINARY" ]; then
                  "$UPX_BINARY" --best --lzma "$obj"
                fi
              fi
            done
            
            # Repackage the library
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to repackage $lib_name"
              ls -la *.o 2>/dev/null || echo "No object files found"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Final verification
            if ! verify_library_macos "$lib"; then
              echo "WARNING: Post-compression verification failed for $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
            rm -rf "$temp_dir"
          }
          
          # Function to compress shared library for macOS
          compress_shared_lib_macos() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing shared library: $lib_name"
            
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            strip -x "$lib" 2>/dev/null || true
            
            if [ -n "$UPX_BINARY" ]; then
              "$UPX_BINARY" --best --lzma "$lib"
            fi
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
          }
          
          # Process all static libraries safely with enhanced verification
          echo "Checking for .a files in: artifacts/macos-${{ matrix.arch }}/lib/"
          if ls artifacts/macos-${{ matrix.arch }}/lib/*.a 1> /dev/null 2>&1; then
            echo "Found .a files, processing..."
            for lib in artifacts/macos-${{ matrix.arch }}/lib/*.a; do
              echo "Checking file: $lib"
              if [ -f "$lib" ]; then
                compress_static_lib_macos "$lib"
              else
                echo "WARNING: Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
            echo "Available files in directory:"
            ls -la artifacts/macos-${{ matrix.arch }}/lib/ 2>/dev/null || echo "Directory not accessible"
          fi
          
          # Process all shared libraries safely
          if ls artifacts/macos-${{ matrix.arch }}/lib/*.dylib 1> /dev/null 2>&1; then
            for lib in artifacts/macos-${{ matrix.arch }}/lib/*.dylib; do
              if [ -f "$lib" ]; then
                compress_shared_lib_macos "$lib"
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .dylib files found to process"
          fi
          
      - name: Final size verification
        run: |
          echo "Library file sizes:"
          if ls artifacts/macos-${{ matrix.arch }}/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/macos-${{ matrix.arch }}/lib/*; do
              if [ -f "$f" ]; then
                echo "$(basename "$f"): $(du -h "$f" | cut -f1)"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luau-macos-${{ matrix.arch }}
          path: artifacts/
          retention-days: 30

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [armv7, arm64-v8a, x86, x86_64]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          api-level: 21
          
      - name: Install additional dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y upx-ucl cmake ninja-build
          
      - name: Setup UPX
        run: |
          wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          chmod +x upx-4.2.2-amd64_linux/upx
          sudo cp upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          
      - name: Configure CMake for Android
        run: |
          if [ "${{ matrix.abi }}" = "armv7" ]; then ANDROID_ABI="armeabi-v7a"; fi
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then ANDROID_ABI="arm64-v8a"; fi
          if [ "${{ matrix.abi }}" = "x86" ]; then ANDROID_ABI="x86"; fi
          if [ "${{ matrix.abi }}" = "x86_64" ]; then ANDROID_ABI="x86_64"; fi
          
          mkdir -p luau-build/build-android-${{ matrix.abi }}
          cd luau-build/build-android-${{ matrix.abi }}
          cmake ../.. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLUAU_BUILD_TOOLS=ON \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="$ANDROID_ABI" \
            -DANDROID_PLATFORM=android-21 \
            -DANDROID_STL=c++_shared \
            -DANDROID_CPP_FEATURES=""
          cmake --build . --config Release -j$(nproc)
          
      - name: Create artifacts directory
        run: |
          mkdir -p artifacts/android-${{ matrix.abi }}/lib
          
      - name: Copy static libraries with verification and detailed logging
        run: |
          echo "Copying static libraries..."
          if find luau-build/build-android-${{ matrix.abi }} -name "*.a" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-android-${{ matrix.abi }} -name "*.a" -exec bash -c '
              for file do
                echo "Found static library: $file"
                target="artifacts/android-'"${{ matrix.abi }}"'/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' bash {} +
          else
            echo "No .a files found in build directory"
            echo "Build directory contents:"
            find luau-build/build-android-${{ matrix.abi }} -type f 2>/dev/null | head -10
          fi
          
      - name: Copy shared libraries with verification and detailed logging
        run: |
          echo "Copying shared libraries..."
          if find luau-build/build-android-${{ matrix.abi }} -name "*.so" 2>/dev/null | head -1 | grep -q .; then
            find luau-build/build-android-${{ matrix.abi }} -name "*.so" -exec bash -c '
              for file do
                echo "Found shared library: $file"
                target="artifacts/android-'"${{ matrix.abi }}"'/lib/$(basename "$file")"
                echo "Copying $file to $target"
                if cp "$file" "$target"; then
                  echo "Successfully copied to: $target"
                  echo "File size: $(du -h "$target" | cut -f1)"
                else
                  echo "ERROR: Failed to copy $file"
                fi
              done
            ' bash {} +
          else
            echo "No .so files found in build directory"
          fi
          
      - name: Verify copied files
        run: |
          echo "Files in artifacts directory:"
          ls -la artifacts/android-${{ matrix.abi }}/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
      - name: Setup compression tools
        run: |
          AR_BIN=$(which llvm-ar 2>/dev/null || which ar)
          STRIP_BIN=$(which llvm-strip 2>/dev/null || which strip)
          
      - name: Compress libraries
        run: |
          # Function to verify library integrity for Android
          verify_android_library() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
          }
          
          # Function to compress static library for Android
          compress_android_static_lib() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists with enhanced verification
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            # Check library integrity before processing
            if ! verify_android_library "$lib"; then
              echo "ERROR: Library integrity check failed for $lib_name"
              return 1
            fi
            
            # Extract object files safely with better error handling
            temp_dir=$(mktemp -d)
            cd "$temp_dir"
            
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              ls -la "$lib" 2>/dev/null || echo "Cannot access file"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" 2>/dev/null | wc -l)
            echo "Found $object_count object files"
            
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Strip and compress each object file
            echo "Compressing object files..."
            for obj in *.o; do
              if [ -f "$obj" ]; then
                if [ -n "$STRIP_BIN" ]; then
                  "$STRIP_BIN" --strip-all --remove-section=.comment --remove-section=.note "$obj"
                fi
                upx --best --lzma "$obj" || true
              fi
            done
            
            # Repackage the library
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to repackage $lib_name"
              ls -la *.o 2>/dev/null || echo "No object files found"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Final verification
            if ! verify_android_library "$lib"; then
              echo "WARNING: Post-compression verification failed for $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
            rm -rf "$temp_dir"
          }
          
          # Function to compress shared library for Android
          compress_android_shared_lib() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing shared library: $lib_name"
            
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            if [ -n "$STRIP_BIN" ]; then
              "$STRIP_BIN" --strip-all --remove-section=.comment --remove-section=.note "$lib"
            fi
            
            upx --best --lzma "$lib" || true
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
          }
          
          # Process all static libraries safely with enhanced verification
          echo "Checking for .a files in: artifacts/android-${{ matrix.abi }}/lib/"
          if ls artifacts/android-${{ matrix.abi }}/lib/*.a 1> /dev/null 2>&1; then
            echo "Found .a files, processing..."
            for lib in artifacts/android-${{ matrix.abi }}/lib/*.a; do
              echo "Checking file: $lib"
              if [ -f "$lib" ]; then
                compress_android_static_lib "$lib"
              else
                echo "WARNING: Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
            echo "Available files in directory:"
            ls -la artifacts/android-${{ matrix.abi }}/lib/ 2>/dev/null || echo "Directory not accessible"
          fi
          
          # Process all shared libraries safely
          if ls artifacts/android-${{ matrix.abi }}/lib/*.so 1> /dev/null 2>&1; then
            for lib in artifacts/android-${{ matrix.abi }}/lib/*.so; do
              if [ -f "$lib" ]; then
                compress_android_shared_lib "$lib"
              else
                echo "Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .so files found to process"
          fi
          
      - name: Final verification
        run: |
          echo "Android library file sizes:"
          if ls artifacts/android-${{ matrix.abi }}/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/android-${{ matrix.abi }}/lib/*; do
              if [ -f "$f" ]; then
                echo "$(basename "$f"): $(du -h "$f" | cut -f1)"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luau-android-${{ matrix.abi }}
          path: artifacts/
          retention-days: 30

  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        sdk: [iphoneos, iphonesimulator]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install dependencies
        run: |
          brew install cmake ninja upx
          
      - name: Setup UPX
        run: |
          cp "$(brew --prefix)/bin/upx" ./upx
          chmod +x ./upx
          
      - name: Configure iOS build
        run: |
          if [ "${{ matrix.sdk }}" = "iphoneos" ]; then
            MIN_OS_VERSION="12.0"
          else
            MIN_OS_VERSION="12.0"
          fi
          
      - name: Build iOS libraries
        run: |
          mkdir -p luau-build/build-ios-${{ matrix.sdk }}
          cd luau-build/build-ios-${{ matrix.sdk }}
          cmake ../.. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLUAU_BUILD_TOOLS=ON \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="$MIN_OS_VERSION" \
            -DCMAKE_XCODE_ATTRIBUTE_ONLY_ACTIVE_ARCH=NO \
            -DCMAKE_OSX_ARCHITECTURES="arm64" \
            -DCMAKE_OSX_PLATFORM_NAME=iOS
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          
      - name: Create artifacts directory
        run: |
          mkdir -p artifacts/ios-${{ matrix.sdk }}/lib
          
      - name: Copy static libraries with verification and detailed logging
        run: |
          echo "Copying static libraries..."
          if [ -d "luau-build/build-ios-${{ matrix.sdk }}/Release" ]; then
            if find luau-build/build-ios-${{ matrix.sdk }}/Release -name "*.a" 2>/dev/null | head -1 | grep -q .; then
              find luau-build/build-ios-${{ matrix.sdk }}/Release -name "*.a" -exec bash -c '
                for file do
                  echo "Found static library: $file"
                  target="artifacts/ios-'"${{ matrix.sdk }}"'/lib/$(basename "$file")"
                  echo "Copying $file to $target"
                  if cp "$file" "$target"; then
                    echo "Successfully copied to: $target"
                    echo "File size: $(du -h "$target" | cut -f1)"
                  else
                    echo "ERROR: Failed to copy $file"
                  fi
                done
              ' bash {} +
            else
              echo "No .a files found in Release directory"
              echo "Release directory contents:"
              find luau-build/build-ios-${{ matrix.sdk }}/Release -type f 2>/dev/null | head -10
            fi
          else
            echo "Release directory not found, trying to find .a files anywhere"
            if find luau-build/build-ios-${{ matrix.sdk }} -name "*.a" 2>/dev/null | head -1 | grep -q .; then
              find luau-build/build-ios-${{ matrix.sdk }} -name "*.a" -exec bash -c '
                for file do
                  echo "Found static library: $file"
                  target="artifacts/ios-'"${{ matrix.sdk }}"'/lib/$(basename "$file")"
                  echo "Copying $file to $target"
                  if cp "$file" "$target"; then
                    echo "Successfully copied to: $target"
                    echo "File size: $(du -h "$target" | cut -f1)"
                  else
                    echo "ERROR: Failed to copy $file"
                  fi
                done
              ' bash {} +
            else
              echo "No .a files found anywhere in build directory"
              echo "Build directory contents:"
              find luau-build/build-ios-${{ matrix.sdk }} -type f 2>/dev/null | head -10
            fi
          fi
          
      - name: Verify copied files
        run: |
          echo "Files in artifacts directory:"
          ls -la artifacts/ios-${{ matrix.sdk }}/lib/ 2>/dev/null || echo "No files found in artifacts directory"
          
      - name: Setup compression tools
        run: |
          if [ -z "$UPX_BINARY" ]; then
            UPX_BINARY="./upx"
          fi
          
      - name: Compress libraries
        run: |
          # Function to verify library integrity for iOS
          verify_ios_library() {
            local lib="$1"
            if ! ar t "$lib" > /dev/null 2>&1; then
              echo "WARNING: Library integrity check failed for $(basename "$lib")"
              return 1
            fi
          }
          
          # Function to compress static library for iOS
          compress_ios_static_lib() {
            local lib="$1"
            local lib_name=$(basename "$lib")
            
            echo "Processing static library: $lib_name"
            echo "Full path: $lib"
            
            # Check if file actually exists with enhanced verification
            if [ ! -f "$lib" ]; then
              echo "ERROR: File does not exist: $lib"
              return 1
            fi
            
            # Check library integrity before processing
            if ! verify_ios_library "$lib"; then
              echo "ERROR: Library integrity check failed for $lib_name"
              return 1
            fi
            
            # Extract object files safely with better error handling
            temp_dir=$(mktemp -d)
            cd "$temp_dir"
            
            if ! ar x "$lib"; then
              echo "ERROR: Failed to extract $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local object_count=$(find . -name "*.o" | wc -l)
            if [ "$object_count" -eq 0 ]; then
              echo "WARNING: No object files found in $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Compress each object file
            echo "Compressing object files..."
            for obj in *.o; do
              if [ -f "$obj" ]; then
                strip -x "$obj" 2>/dev/null || true
                if [ -n "$UPX_BINARY" ]; then
                  "$UPX_BINARY" --best --lzma "$obj" 2>/dev/null || true
                fi
              fi
            done
            
            # Repackage the library
            if ! ar rcs "$lib" *.o; then
              echo "ERROR: Failed to repackage $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # Final verification
            if ! verify_ios_library "$lib"; then
              echo "WARNING: Post-compression verification failed for $lib_name"
              rm -rf "$temp_dir"
              return 1
            fi
            
            local final_size=$(du -h "$lib" | cut -f1)
            echo "Successfully compressed $lib_name. Final size: $final_size"
            rm -rf "$temp_dir"
          }
          
          # Process all static libraries safely with enhanced verification
          echo "Checking for .a files in: artifacts/ios-${{ matrix.sdk }}/lib/"
          if ls artifacts/ios-${{ matrix.sdk }}/lib/*.a 1> /dev/null 2>&1; then
            echo "Found .a files, processing..."
            for lib in artifacts/ios-${{ matrix.sdk }}/lib/*.a; do
              echo "Checking file: $lib"
              if [ -f "$lib" ]; then
                compress_ios_static_lib "$lib"
              else
                echo "WARNING: Skipping non-existent file: $lib"
              fi
            done
          else
            echo "No .a files found to process"
            echo "Available files in directory:"
            ls -la artifacts/ios-${{ matrix.sdk }}/lib/ 2>/dev/null || echo "Directory not accessible"
          fi
          
      - name: Final size verification
        run: |
          echo "iOS library file sizes:"
          if ls artifacts/ios-${{ matrix.sdk }}/lib/* 1> /dev/null 2>&1; then
            for f in artifacts/ios-${{ matrix.sdk }}/lib/*; do
              if [ -f "$f" ]; then
                echo "$(basename "$f"): $(du -h "$f" | cut -f1)"
              fi
            done
          else
            echo "No files found in artifacts directory"
          fi
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luau-ios-${{ matrix.sdk }}
          path: artifacts/
          retention-days: 30

  update-repo:
    needs: [build-windows, build-linux, build-macos, build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Organize artifacts by platform
        run: |
          mkdir -p lib/luau/lib/{windows-x64,linux-x64,macos-x86_64,macos-arm64,android-armv7,android-arm64-v8a,android-x86,android-x86_64,ios-iphoneos,ios-iphonesimulator}
          
          # Copy Windows artifacts
          if [ -d "luau-windows-x64/artifacts/windows-x64/lib" ]; then
            cp luau-windows-x64/artifacts/windows-x64/lib/* lib/luau/lib/windows-x64/ 2>/dev/null || true
          fi
          
          # Copy Linux artifacts
          if [ -d "luau-linux-x64/artifacts/linux-x64/lib" ]; then
            cp luau-linux-x64/artifacts/linux-x64/lib/* lib/luau/lib/linux-x64/ 2>/dev/null || true
          fi
          
          # Copy macOS artifacts
          if [ -d "luau-macos-x86_64/artifacts/macos-x86_64/lib" ]; then
            cp luau-macos-x86_64/artifacts/macos-x86_64/lib/* lib/luau/lib/macos-x86_64/ 2>/dev/null || true
          fi
          
          if [ -d "luau-macos-arm64/artifacts/macos-arm64/lib" ]; then
            cp luau-macos-arm64/artifacts/macos-arm64/lib/* lib/luau/lib/macos-arm64/ 2>/dev/null || true
          fi
          
          # Copy Android artifacts
          if [ -d "luau-android-armv7/artifacts/android-armv7/lib" ]; then
            cp luau-android-armv7/artifacts/android-armv7/lib/* lib/luau/lib/android-armv7/ 2>/dev/null || true
          fi
          
          if [ -d "luau-android-arm64-v8a/artifacts/android-arm64-v8a/lib" ]; then
            cp luau-android-arm64-v8a/artifacts/android-arm64-v8a/lib/* lib/luau/lib/android-arm64-v8a/ 2>/dev/null || true
          fi
          
          if [ -d "luau-android-x86/artifacts/android-x86/lib" ]; then
            cp luau-android-x86/artifacts/android-x86/lib/* lib/luau/lib/android-x86/ 2>/dev/null || true
          fi
          
          if [ -d "luau-android-x86_64/artifacts/android-x86_64/lib" ]; then
            cp luau-android-x86_64/artifacts/android-x86_64/lib/* lib/luau/lib/android-x86_64/ 2>/dev/null || true
          fi
          
          # Copy iOS artifacts
          if [ -d "luau-ios-iphoneos/artifacts/ios-iphoneos/lib" ]; then
            cp luau-ios-iphoneos/artifacts/ios-iphoneos/lib/* lib/luau/lib/ios-iphoneos/ 2>/dev/null || true
          fi
          
          if [ -d "luau-ios-iphonesimulator/artifacts/ios-iphonesimulator/lib" ]; then
            cp luau-ios-iphonesimulator/artifacts/ios-iphonesimulator/lib/* lib/luau/lib/ios-iphonesimulator/ 2>/dev/null || true
          fi
          
      - name: Display final directory structure
        run: |
          echo "Final directory structure:"
          find lib/luau/lib -type f | sort
          
      - name: Update version info
        run: |
          echo "$LUAU_VERSION" > lib/luau/VERSION
          
      - name: Create commit
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all files
          git add .
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Commit and push
          git commit -m "Update Luau libraries to version $LUAU_VERSION"
          git push
          
      - name: Final verification - ensure all files are under 100MB and functional
        run: |
          echo "Final file size and integrity verification:"
          for platform in lib/luau/lib/*; do
            if [ -d "$platform" ]; then
              platform_name=$(basename "$platform")
              echo "Checking platform: $platform_name"
              if [ -d "lib/luau/lib/$platform_name" ]; then
                for lib in lib/luau/lib/$platform_name/*; do
                  if [ -f "$lib" ]; then
                    lib_name=$(basename "$lib")
                    size=$(du -b "$lib" | cut -f1)
                    size_mb=$((size / 1024 / 1024))
                    
                    echo "  $lib_name:"
                    echo "    Size: ${size_mb}MB"
                    
                    # Verify library integrity
                    if ar t "$lib" > /dev/null 2>&1; then
                      symbol_count=$(ar t "$lib" | wc -l)
                      echo "    Contains $symbol_count object files"
                    fi
                    
                    # Check if file is too large
                    if [ "$size_mb" -gt 95 ]; then
                      echo "    WARNING: File is very large (${size_mb}MB)"
                    fi
                  fi
                done
              fi
            fi
          done
          
      - name: Create release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: lib/**/*
          body: |
            Luau libraries version ${{ env.LUAU_VERSION }}
            
            This release contains precompiled libraries for all supported platforms.
            
            ## Included platforms
            - Windows x64
            - Linux x64
            - macOS x86_64
            - macOS arm64
            - Android (armv7, arm64-v8a, x86, x86_64)
            - iOS (iPhoneOS, iPhoneSimulator)
            
            All libraries have been compressed and optimized for size.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
